<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lupin Cred - Calculadora de Juros Profissional</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        html {
            height: 100%;
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .container {
            max-width: calc(100vw - 10px);
            width: calc(100vw - 10px);
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 10px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.8rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        .calculator-section {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.85rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .preset-btn {
            padding: 6px 8px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: #3498db;
            color: white;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .results {
            background: white;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .result-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }

        .result-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .result-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .profit-value {
            color: #27ae60;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.7rem;
        }

        .comparison-table th {
            background: #3498db;
            color: white;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .comparison-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.7rem;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .history-section {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .history-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .clear-history {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .clear-history:hover {
            background: #c0392b;
        }

        .tips-section {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            width: 100%;
            max-width: 100%;
        }

        .advanced-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .advanced-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .advanced-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: white;
        }

        .conversion-controls, .deadline-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .conversion-controls input, .deadline-controls input {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
        }

        .conversion-controls input::placeholder, .deadline-controls input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .convert-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .convert-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .conversion-result {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
            text-align: center;
            min-height: 20px;
        }

        .loan-actions {
            margin-top: 15px;
        }

        .loan-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .loan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
        }

        .statistics-section {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 3px solid #3498db;
        }

        .stat-icon {
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 50%;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 500;
        }

        .customer-section {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            width: 100%;
            max-width: 100%;
        }

        .customer-section input, .customer-section textarea {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
        }

        .customer-section input::placeholder, .customer-section textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .customer-section label {
            color: white;
        }

        .customers-list {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .customer-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .customer-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .customer-debt {
            font-size: 1rem;
            font-weight: 600;
            color: #e74c3c;
        }

        .customer-info {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .due-date {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }

        .overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .customer-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .paid-btn {
            background: #27ae60;
            color: white;
        }

        .paid-btn:hover {
            background: #219a52;
        }

        .contact-btn {
            background: #3498db;
            color: white;
        }

        .contact-btn:hover {
            background: #2980b9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-row-full {
            grid-column: 1 / -1;
        }

        /* Estilos para o sistema de fotos */
        .photo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px dashed rgba(255,255,255,0.3);
        }

        .photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-preview:hover {
            border-color: rgba(255,255,255,0.6);
            transform: scale(1.05);
        }

        .photo-placeholder {
            text-align: center;
            color: rgba(255,255,255,0.8);
        }

        .photo-placeholder span {
            font-size: 2rem;
            display: block;
            margin-bottom: 5px;
        }

        .photo-placeholder p {
            margin: 0;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-btn {
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .photo-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .camera-btn:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }

        .gallery-btn:hover {
            background: rgba(155, 89, 182, 0.3);
            border-color: #9b59b6;
        }

        .remove-btn:hover {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
        }

        .customer-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e74c3c;
            margin-right: 15px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .customer-photo:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .customer-header-with-photo {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .customer-info-section {
            flex: 1;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .photo-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .photo-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Estilos para sistema de documentos */
        .documents-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px dashed rgba(255,255,255,0.3);
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .document-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .document-item:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .document-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 8px;
            border-radius: 6px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .document-icon {
            font-size: 2rem;
            color: rgba(255,255,255,0.8);
        }

        .document-name {
            font-size: 0.7rem;
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .document-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .document-remove:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .add-document {
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.4);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.8);
        }

        .add-document:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
        }

        .document-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .doc-type-btn {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doc-type-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .customer-documents {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .customer-documents h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-docs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .customer-doc-item {
            background: white;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .customer-doc-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .customer-doc-preview {
            width: 60px;
            height: 60px;
            margin: 0 auto 5px;
            border-radius: 4px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .customer-doc-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .customer-doc-name {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 600;
        }

        .document-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .document-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .document-modal-content {
            max-width: 90%;
            max-height: 80%;
            position: relative;
        }

        .document-modal img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .document-modal-info {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .document-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .document-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .header h1 {
            font-size: 2rem;
        }
        
        .preset-buttons {
            grid-template-columns: repeat(2, 1fr);
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Estilos para sele√ß√£o de clientes */
        .customer-selection-item {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .customer-selection-item:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .customer-selection-item.selected {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }

        .customer-selection-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
        }

        .customer-selection-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255,255,255,0.8);
            flex-shrink: 0;
        }

        .customer-selection-info {
            flex: 1;
            color: white;
        }

        .customer-selection-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .customer-selection-details {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .customer-selection-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-active {
            background: rgba(231, 76, 60, 0.3);
            color: #fff;
            border: 1px solid #e74c3c;
        }

        .status-paid {
            background: rgba(46, 204, 113, 0.3);
            color: #fff;
            border: 1px solid #2ecc71;
        }

        .confirm-selection-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            opacity: 0.5;
            pointer-events: none;
        }

        .confirm-selection-btn.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .confirm-selection-btn.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        /* Estilos para modal de pagamento */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .payment-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .payment-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .payment-modal.active .payment-modal-content {
            transform: scale(1);
        }

        .payment-modal-header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .payment-modal-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .payment-info {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .payment-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.95rem;
        }

        .payment-row.total {
            border-top: 2px solid #27ae60;
            margin-top: 10px;
            padding-top: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #27ae60;
        }

        .payment-options {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .payment-option-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        .payment-option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .payment-option-btn.full-payment {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .payment-option-btn.full-payment:hover {
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .payment-option-btn.interest-payment {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .payment-option-btn.interest-payment:hover {
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
        }

        .payment-option-btn.custom-payment {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .payment-option-btn.custom-payment:hover {
            box-shadow: 0 8px 20px rgba(155, 89, 182, 0.3);
        }

        .payment-option-btn.confirm-custom {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            margin-top: 15px;
        }

        .payment-option-btn.confirm-custom:hover {
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }

        .payment-option-btn span {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .custom-payment-section {
            padding: 0 20px 20px;
            border-top: 1px solid #e9ecef;
            margin-top: 15px;
            padding-top: 20px;
        }

        .custom-payment-section .form-group {
            margin-bottom: 15px;
        }

        .custom-payment-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .custom-payment-section input,
        .custom-payment-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .custom-payment-section input:focus,
        .custom-payment-section textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .custom-payment-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Hist√≥rico de pagamentos */
        .payment-history {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }

        .payment-history h4 {
            margin: 0 0 15px 0;
            color: #27ae60;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payment-history-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #d4edda;
            font-size: 0.85rem;
        }

        .payment-history-item:last-child {
            margin-bottom: 0;
        }

        .payment-date {
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 5px;
        }

        .payment-details {
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-amount {
            font-weight: 600;
            color: #27ae60;
        }

        /* Anima√ß√£o para notifica√ß√£o de atraso */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .overdue-notification {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <main class="container">
        <header class="header">
            <h1>üí∞ Lupin Cred</h1>
            <p>Calculadora de Juros Profissional - Gerencie seus empr√©stimos com precis√£o</p>
        </header>

        <div class="main-content">
            <section class="calculator-section" style="position: relative;">
                <div id="saveIndicator" style="position: absolute; top: 10px; right: 10px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.7rem; opacity: 0; transition: opacity 0.3s;">
                    üíæ Dados Salvos
                </div>
                <h2 class="section-title">
                    üßÆ Calculadora Principal
                </h2>
                
                <form id="loanForm">
                    <div class="form-group">
                        <label for="principal">Valor do Empr√©stimo (R$)</label>
                        <input type="number" id="principal" step="0.01" min="0" placeholder="Ex: 1000.00" required>
                    </div>

                    <div class="form-group">
                        <label for="interestRate">Taxa de Juros (%)</label>
                        <input type="number" id="interestRate" step="0.1" min="0" placeholder="Ex: 30.0" required>
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn" onclick="setRate(15)">15%</button>
                            <button type="button" class="preset-btn" onclick="setRate(20)">20%</button>
                            <button type="button" class="preset-btn" onclick="setRate(25)">25%</button>
                            <button type="button" class="preset-btn" onclick="setRate(30)">30%</button>
                            <button type="button" class="preset-btn" onclick="setRate(35)">35%</button>
                            <button type="button" class="preset-btn" onclick="setRate(40)">40%</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="period">Per√≠odo</label>
                        <input type="number" id="period" min="1" placeholder="Ex: 30" required>
                    </div>

                    <div class="form-group">
                        <label for="periodType">Tipo de Per√≠odo</label>
                        <select id="periodType" required>
                            <option value="days">Dias</option>
                            <option value="months">Meses</option>
                            <option value="years">Anos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="interestType">Tipo de Juros</label>
                        <select id="interestType" required>
                            <option value="simple">Juros Simples</option>
                            <option value="compound">Juros Compostos</option>
                        </select>
                    </div>

                    <button type="submit" class="calculate-btn">
                        üìä Calcular Empr√©stimo
                    </button>
                    
                    <div class="loan-actions" style="display: none;" id="loanActions">
                        <button type="button" class="loan-btn" onclick="showCustomerSelection()">
                            üë§ Selecionar Cliente e Emprestar
                        </button>
                    </div>
                </form>
            </section>

            <section class="results">
                <h2 class="section-title">
                    üìà Resultados
                </h2>
                
                <div id="resultsContainer">
                    <div class="result-card">
                        <div class="result-label">Valor Total a Receber</div>
                        <div class="result-value" id="totalAmount">R$ 0,00</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">Juros Ganhos</div>
                        <div class="result-value profit-value" id="interestEarned">R$ 0,00</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">Rentabilidade</div>
                        <div class="result-value" id="profitability">0%</div>
                    </div>
                </div>

                <table class="comparison-table" id="comparisonTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Taxa</th>
                            <th>Juros</th>
                            <th>Total</th>
                            <th>Diferen√ßa</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                    </tbody>
                </table>
            </section>

            <section class="customer-section" id="customerSelectionSection" style="display: none;">
                <h2 class="section-title" style="color: white;">
                    üë§ Selecionar Cliente
                </h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button type="button" class="convert-btn" onclick="showExistingCustomers()" style="flex: 1; padding: 15px; font-size: 1rem;">
                        üìã Cliente Existente
                    </button>
                    <button type="button" class="convert-btn" onclick="showNewCustomerForm()" style="flex: 1; padding: 15px; font-size: 1rem;">
                        ‚ûï Novo Cliente
                    </button>
                </div>
                
                <!-- Lista de clientes existentes -->
                <div id="existingCustomersSection" style="display: none;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 15px; text-align: center;">
                        Selecione um cliente para fazer um novo empr√©stimo:
                    </div>
                    <div id="existingCustomersList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Lista ser√° preenchida dinamicamente -->
                    </div>
                </div>
                
                <!-- Formul√°rio para novo cliente -->
                <div id="newCustomerSection" style="display: none;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 15px; text-align: center;">
                        Cadastre um novo cliente:
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="clear-history" onclick="hideCustomerSelection()" style="flex: 0 0 auto;">
                        Cancelar
                    </button>
                </div>
            </section>

            <section class="customer-section" id="customerSection" style="display: none;">
                <h2 class="section-title" style="color: white;">
                    üë§ Cadastro do Cliente
                </h2>
                
                <form id="customerForm">
                    <div class="form-group">
                        <label>üì∏ Foto do Cliente</label>
                        <div class="photo-section">
                            <div class="photo-preview" id="photoPreview" onclick="selectPhoto()">
                                <div class="photo-placeholder">
                                    <span>üì∑</span>
                                    <p>Adicionar Foto</p>
                                </div>
                            </div>
                            <div class="photo-buttons">
                                <button type="button" class="photo-btn camera-btn" onclick="takePhoto()">
                                    üì∑ C√¢mera
                                </button>
                                <button type="button" class="photo-btn gallery-btn" onclick="selectFromGallery()">
                                    üñºÔ∏è Galeria
                                </button>
                                <button type="button" class="photo-btn remove-btn" onclick="removePhoto()" style="display: none;" id="removePhotoBtn">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoSelect(event)">
                            <input type="file" id="galleryInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìÑ Documentos do Cliente (opcional)</label>
                        <div class="documents-section">
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.8rem; margin-bottom: 15px; text-align: center;">
                                Adicione documentos como RG, CPF, comprovante de resid√™ncia, etc.
                            </div>
                            
                            <div class="documents-grid" id="documentsGrid">
                                <div class="add-document" onclick="showDocumentTypes()">
                                    <div style="font-size: 2rem; margin-bottom: 8px;">üìé</div>
                                    <div style="font-size: 0.8rem; font-weight: 600;">Adicionar Documento</div>
                                </div>
                            </div>
                            
                            <div class="document-types" id="documentTypes" style="display: none;">
                                <button type="button" class="doc-type-btn" onclick="addDocument('rg')">
                                    üÜî RG / Identidade
                                </button>
                                <button type="button" class="doc-type-btn" onclick="addDocument('cpf')">
                                    üìã CPF
                                </button>
                                <button type="button" class="doc-type-btn" onclick="addDocument('comprovante')">
                                    üè† Comp. Resid√™ncia
                                </button>
                                <button type="button" class="doc-type-btn" onclick="addDocument('renda')">
                                    üí∞ Comp. Renda
                                </button>
                                <button type="button" class="doc-type-btn" onclick="addDocument('contrato')">
                                    üìù Contrato
                                </button>
                                <button type="button" class="doc-type-btn" onclick="addDocument('outro')">
                                    üìÑ Outro
                                </button>
                            </div>
                            
                            <input type="file" id="documentInput" accept="image/*,application/pdf" style="display: none;" onchange="handleDocumentSelect(event)">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Nome Completo *</label>
                            <input type="text" id="customerName" placeholder="Ex: Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Celular *</label>
                            <input type="tel" id="customerPhone" placeholder="(11) 99999-9999" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerCpf">CPF (opcional)</label>
                            <input type="text" id="customerCpf" placeholder="000.000.000-00">
                        </div>
                        <div class="form-group">
                            <label for="dueDate">Data de Cobran√ßa *</label>
                            <input type="date" id="dueDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerAddress">Endere√ßo (opcional)</label>
                        <textarea id="customerAddress" placeholder="Rua, n√∫mero, bairro, cidade..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="calculate-btn" style="flex: 1;">
                            ‚úÖ Confirmar Empr√©stimo
                        </button>
                        <button type="button" class="clear-history" onclick="hideCustomerForm()" style="flex: 0 0 auto;">
                            Cancelar
                        </button>
                    </div>
                </form>
            </section>

            <section class="customers-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">
                        üë• Clientes Ativos
                    </h2>
                    <button class="clear-history" onclick="clearCustomers()">Limpar Todos</button>
                </div>
                <div id="customersContainer">
                    <p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum cliente cadastrado ainda</p>
                </div>
            </section>

            <section class="history-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">
                        üìã Hist√≥rico de C√°lculos
                    </h2>
                    <button class="clear-history" onclick="clearHistory()">Limpar Hist√≥rico</button>
                </div>
                <div id="historyContainer">
                    <p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum c√°lculo realizado ainda</p>
                </div>
            </section>

            <section class="tips-section">
                <h2 class="section-title" style="color: white;">
                    üí° Calculadora Avan√ßada
                </h2>
                <div class="advanced-grid">
                    <div class="advanced-card">
                        <div class="advanced-title">üîÑ Convers√£o de Taxas</div>
                        <div class="conversion-controls">
                            <input type="number" id="monthlyRate" placeholder="Taxa mensal %" step="0.1">
                            <button onclick="convertRates()" class="convert-btn">Converter</button>
                            <div id="conversionResult" class="conversion-result"></div>
                        </div>
                    </div>
                    <div class="advanced-card">
                        <div class="advanced-title">üìÖ Calculadora de Prazo</div>
                        <div class="deadline-controls">
                            <input type="date" id="startDate">
                            <input type="number" id="daysToAdd" placeholder="Dias" min="1">
                            <button onclick="calculateDeadline()" class="convert-btn">Calcular</button>
                            <div id="deadlineResult" class="conversion-result"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="statistics-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">
                        üìä Estat√≠sticas
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="convert-btn" onclick="exportData()" style="padding: 8px 15px; font-size: 0.8rem; background: #3498db; border: 2px solid #2980b9;">
                            üì§ Exportar
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="convert-btn" onclick="document.getElementById('importFile').click()" style="padding: 8px 15px; font-size: 0.8rem; background: #e67e22; border: 2px solid #d35400;">
                            üì• Importar
                        </button>
                        <button class="convert-btn" onclick="resetStatistics()" style="padding: 8px 15px; font-size: 0.8rem; background: #e74c3c; border: 2px solid #c0392b;">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label for="startDateFilter" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.85rem;">Data Inicial</label>
                            <input type="date" id="startDateFilter" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label for="endDateFilter" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.85rem;">Data Final</label>
                            <input type="date" id="endDateFilter" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="filterStatistics()" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                üîç Filtrar
                            </button>
                            <button onclick="clearDateFilter()" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                ‚úñÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                    <div id="dateRangeInfo" style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 0.8rem; color: #1565c0; display: none;">
                        üìÖ Mostrando dados de <span id="dateRangeText"></span>
                    </div>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalLoaned">R$ 0,00</div>
                            <div class="stat-label">Total Emprestado</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalProfit">R$ 0,00</div>
                            <div class="stat-label">Lucro Realizado</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalReceivable">R$ 0,00</div>
                            <div class="stat-label">A Receber</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalReceived">R$ 0,00</div>
                            <div class="stat-label">J√° Recebido</div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #e74c3c;">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">‚ö†Ô∏è</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalOverdue" style="color: #e74c3c;">R$ 0,00</div>
                            <div class="stat-label">Juros de Atraso</div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #e74c3c;">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">üö®</div>
                        <div class="stat-content">
                            <div class="stat-value" id="overdueCount" style="color: #e74c3c;">0</div>
                            <div class="stat-label">Em Atraso</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="avgRate">0%</div>
                            <div class="stat-label">Taxa M√©dia</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalCalculations">0</div>
                            <div class="stat-label">C√°lculos Hoje</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal para visualizar foto em tela cheia -->
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal()">
        <button class="photo-modal-close" onclick="closePhotoModal()">‚úï</button>
        <img id="photoModalImage" src="" alt="Foto do Cliente">
    </div>

    <!-- Modal para visualizar documentos -->
    <div class="document-modal" id="documentModal" onclick="closeDocumentModal()">
        <button class="document-modal-close" onclick="closeDocumentModal()">‚úï</button>
        <div class="document-modal-content" onclick="event.stopPropagation()">
            <img id="documentModalImage" src="" alt="Documento">
            <div class="document-modal-info" id="documentModalInfo">
                <h3 id="documentModalTitle">Documento</h3>
                <p id="documentModalDescription">Clique fora da imagem para fechar</p>
            </div>
        </div>
    </div>

    <!-- Modal para op√ß√µes de pagamento -->
    <div class="payment-modal" id="paymentModal" onclick="closePaymentModal()">
        <div class="payment-modal-content" onclick="event.stopPropagation()">
            <div class="payment-modal-header">
                <h3 id="paymentModalTitle">üí∞ Receber Pagamento</h3>
                <button class="payment-modal-close" onclick="closePaymentModal()">‚úï</button>
            </div>
            
            <div class="payment-info">
                <div class="payment-summary">
                    <div class="payment-row">
                        <span>Valor Original:</span>
                        <span id="originalAmount">R$ 0,00</span>
                    </div>
                    <div class="payment-row">
                        <span>Juros de Atraso:</span>
                        <span id="overdueAmount">R$ 0,00</span>
                    </div>
                    <div class="payment-row total">
                        <span>Total Atual:</span>
                        <span id="currentTotalAmount">R$ 0,00</span>
                    </div>
                </div>
            </div>
            
            <div class="payment-options">
                <button class="payment-option-btn full-payment" onclick="processFullPayment()">
                    ‚úÖ Pagamento Total
                    <span id="fullPaymentAmount">R$ 0,00</span>
                </button>
                
                <button class="payment-option-btn interest-payment" onclick="processInterestPayment()">
                    üìà S√≥ os Juros
                    <span id="interestPaymentAmount">R$ 0,00</span>
                </button>
                
                <button class="payment-option-btn custom-payment" onclick="showCustomPayment()">
                    üíµ Valor Personalizado
                </button>
            </div>
            
            <div class="custom-payment-section" id="customPaymentSection" style="display: none;">
                <div class="form-group">
                    <label for="customAmount">Valor Recebido (R$)</label>
                    <input type="number" id="customAmount" step="0.01" min="0" placeholder="Ex: 150.00">
                </div>
                <div class="form-group">
                    <label for="paymentNote">Observa√ß√£o (opcional)</label>
                    <textarea id="paymentNote" placeholder="Ex: Pagamento parcial dos juros..."></textarea>
                </div>
                <button class="payment-option-btn confirm-custom" onclick="processCustomPayment()">
                    ‚úÖ Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sistema de Banco de Dados Local Avan√ßado
        class LupinDatabase {
            constructor() {
                this.dbName = 'LupinCredDB';
                this.version = 1;
                this.db = null;
                this.init();
            }

            async init() {
                try {
                    // Tenta usar IndexedDB primeiro (mais robusto)
                    if ('indexedDB' in window) {
                        await this.initIndexedDB();
                    } else {
                        // Fallback para localStorage com backup autom√°tico
                        this.initLocalStorage();
                    }
                    this.setupAutoSave();
                } catch (error) {
                    console.log('Usando localStorage como fallback');
                    this.initLocalStorage();
                }
            }

            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Criar stores se n√£o existirem
                        if (!db.objectStoreNames.contains('customers')) {
                            db.createObjectStore('customers', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('history')) {
                            db.createObjectStore('history', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('stats')) {
                            db.createObjectStore('stats', { keyPath: 'date' });
                        }
                    };
                });
            }

            initLocalStorage() {
                // Migrar dados existentes se necess√°rio
                this.migrateFromLocalStorage();
            }

            migrateFromLocalStorage() {
                const oldCustomers = localStorage.getItem('customers');
                const oldHistory = localStorage.getItem('loanHistory');
                const oldStats = localStorage.getItem('dailyStats');
                
                if (oldCustomers) {
                    this.saveToStorage('customers', JSON.parse(oldCustomers));
                }
                if (oldHistory) {
                    this.saveToStorage('history', JSON.parse(oldHistory));
                }
                if (oldStats) {
                    this.saveToStorage('stats', JSON.parse(oldStats));
                }
            }

            async saveToStorage(store, data) {
                try {
                    if (this.db) {
                        // Usar IndexedDB
                        const transaction = this.db.transaction([store], 'readwrite');
                        const objectStore = transaction.objectStore(store);
                        
                        if (Array.isArray(data)) {
                            // Limpar store primeiro
                            await objectStore.clear();
                            // Adicionar todos os itens
                            data.forEach(item => objectStore.add(item));
                        } else {
                            objectStore.put(data);
                        }
                    } else {
                        // Fallback para localStorage
                        localStorage.setItem(`lupinDB_${store}`, JSON.stringify(data));
                    }
                    this.showSaveIndicator();
                } catch (error) {
                    // Fallback para localStorage em caso de erro
                    localStorage.setItem(`lupinDB_${store}`, JSON.stringify(data));
                    this.showSaveIndicator();
                }
            }

            async loadFromStorage(store) {
                try {
                    if (this.db) {
                        // Usar IndexedDB
                        return new Promise((resolve) => {
                            const transaction = this.db.transaction([store], 'readonly');
                            const objectStore = transaction.objectStore(store);
                            const request = objectStore.getAll();
                            
                            request.onsuccess = () => resolve(request.result || []);
                            request.onerror = () => {
                                // Fallback para localStorage
                                const data = localStorage.getItem(`lupinDB_${store}`);
                                resolve(data ? JSON.parse(data) : []);
                            };
                        });
                    } else {
                        // Usar localStorage
                        const data = localStorage.getItem(`lupinDB_${store}`);
                        return data ? JSON.parse(data) : [];
                    }
                } catch (error) {
                    // Fallback final
                    const data = localStorage.getItem(`lupinDB_${store}`);
                    return data ? JSON.parse(data) : [];
                }
            }

            setupAutoSave() {
                // Salvar dados a cada 30 segundos
                setInterval(() => {
                    this.autoSave();
                }, 30000);

                // Salvar antes de fechar a p√°gina
                window.addEventListener('beforeunload', () => {
                    this.autoSave();
                });

                // Salvar quando a p√°gina perde o foco
                window.addEventListener('blur', () => {
                    this.autoSave();
                });
            }

            autoSave() {
                if (customers.length > 0) {
                    this.saveToStorage('customers', customers);
                }
                if (calculationHistory.length > 0) {
                    this.saveToStorage('history', calculationHistory);
                }
                this.saveToStorage('stats', dailyStats);
            }

            showSaveIndicator() {
                const indicator = document.getElementById('saveIndicator');
                if (indicator) {
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 2000);
                }
            }

            async exportAllData() {
                const data = {
                    customers: await this.loadFromStorage('customers'),
                    history: await this.loadFromStorage('history'),
                    allStats: await this.loadFromStorage('allStats'),
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                return data;
            }

            async importAllData(data) {
                try {
                    if (data.customers) {
                        await this.saveToStorage('customers', data.customers);
                        customers = data.customers;
                    }
                    if (data.history) {
                        await this.saveToStorage('history', data.history);
                        calculationHistory = data.history;
                    }
                    
                    // Compatibilidade com vers√µes antigas
                    if (data.allStats) {
                        await this.saveToStorage('allStats', data.allStats);
                        allStats = data.allStats;
                        // Encontrar estat√≠sticas do dia atual
                        const today = new Date().toDateString();
                        dailyStats = allStats.find(stat => stat.date === today) || {
                            totalLoaned: 0,
                            totalProfit: 0,
                            totalCalculations: 0,
                            rates: [],
                            date: today
                        };
                    } else if (data.stats) {
                        // Importar formato antigo
                        allStats = [data.stats];
                        dailyStats = data.stats;
                        await this.saveToStorage('allStats', allStats);
                    }
                    
                    // Atualizar displays
                    displayCustomers();
                    displayHistory();
                    displayDailyStats();
                    clearDateFilter();
                    
                    return true;
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    return false;
                }
            }
        }

        // Inicializar banco de dados
        const lupinDB = new LupinDatabase();

        // Vari√°veis globais
        let calculationHistory = [];
        let customers = [];
        let allStats = []; // Array para armazenar estat√≠sticas de m√∫ltiplas datas
        let dailyStats = {
            totalLoaned: 0,
            totalProfit: 0,
            totalCalculations: 0,
            rates: [],
            date: new Date().toDateString(),
            // Novas estat√≠sticas separadas
            totalReceivable: 0, // Total a receber (empr√©stimos ativos)
            totalReceived: 0,   // Total j√° recebido (empr√©stimos pagos)
            totalOverdue: 0,    // Total em atraso
            overdueCount: 0     // Quantidade de empr√©stimos em atraso
        };
        let currentCalculation = null;
        let currentStatsFilter = null; // Para controlar o filtro atual
        let currentPhotoData = null; // Para armazenar foto atual
        let currentDocuments = []; // Para armazenar documentos atuais
        let currentDocumentType = null; // Para controlar o tipo de documento sendo adicionado

        // Fun√ß√µes para gerenciar fotos
        function takePhoto() {
            document.getElementById('photoInput').click();
        }

        function selectFromGallery() {
            document.getElementById('galleryInput').click();
        }

        function selectPhoto() {
            // Permite clicar na √°rea da foto para selecionar
            selectFromGallery();
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Verificar se √© uma imagem
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }

            // Verificar tamanho do arquivo (m√°ximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('A imagem √© muito grande. Por favor, selecione uma imagem menor que 5MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Redimensionar a imagem para economizar espa√ßo
                resizeImage(e.target.result, 400, 400, (resizedImage) => {
                    currentPhotoData = resizedImage;
                    displayPhoto(resizedImage);
                });
            };
            reader.readAsDataURL(file);
        }

        function resizeImage(src, maxWidth, maxHeight, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Calcular novas dimens√µes mantendo propor√ß√£o
                let { width, height } = img;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                }

                canvas.width = width;
                canvas.height = height;

                // Desenhar imagem redimensionada
                ctx.drawImage(img, 0, 0, width, height);

                // Converter para base64 com qualidade reduzida
                const resizedImage = canvas.toDataURL('image/jpeg', 0.8);
                callback(resizedImage);
            };
            img.src = src;
        }

        function displayPhoto(photoData) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<img src="${photoData}" alt="Foto do Cliente">`;
            
            // Mostrar bot√£o de remover
            document.getElementById('removePhotoBtn').style.display = 'block';
        }

        function removePhoto() {
            currentPhotoData = null;
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `
                <div class="photo-placeholder">
                    <span>üì∑</span>
                    <p>Adicionar Foto</p>
                </div>
            `;
            
            // Esconder bot√£o de remover
            document.getElementById('removePhotoBtn').style.display = 'none';
            
            // Limpar inputs
            document.getElementById('photoInput').value = '';
            document.getElementById('galleryInput').value = '';
        }

        function openPhotoModal(photoSrc) {
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('photoModalImage');
            
            modalImage.src = photoSrc;
            modal.classList.add('active');
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('active');
        }

        // Fun√ß√µes para gerenciar documentos
        function showDocumentTypes() {
            const typesDiv = document.getElementById('documentTypes');
            typesDiv.style.display = typesDiv.style.display === 'none' ? 'grid' : 'none';
        }

        function addDocument(type) {
            currentDocumentType = type;
            document.getElementById('documentInput').click();
            document.getElementById('documentTypes').style.display = 'none';
        }

        function handleDocumentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Verificar se √© uma imagem ou PDF
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                alert('Por favor, selecione apenas imagens ou arquivos PDF.');
                return;
            }

            // Verificar tamanho do arquivo (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('O arquivo √© muito grande. Por favor, selecione um arquivo menor que 10MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const documentData = {
                    id: Date.now(),
                    type: currentDocumentType,
                    name: getDocumentTypeName(currentDocumentType),
                    data: e.target.result,
                    fileName: file.name,
                    fileType: file.type,
                    uploadDate: new Date().toLocaleDateString('pt-BR')
                };

                // Se for imagem, redimensionar para economizar espa√ßo
                if (file.type.startsWith('image/')) {
                    resizeImage(e.target.result, 800, 800, (resizedImage) => {
                        documentData.data = resizedImage;
                        currentDocuments.push(documentData);
                        displayDocuments();
                    });
                } else {
                    // Para PDFs, manter o arquivo original
                    currentDocuments.push(documentData);
                    displayDocuments();
                }
            };
            reader.readAsDataURL(file);

            // Limpar input
            event.target.value = '';
        }

        function getDocumentTypeName(type) {
            const types = {
                'rg': 'RG / Identidade',
                'cpf': 'CPF',
                'comprovante': 'Comprovante de Resid√™ncia',
                'renda': 'Comprovante de Renda',
                'contrato': 'Contrato',
                'outro': 'Outro Documento'
            };
            return types[type] || 'Documento';
        }

        function getDocumentIcon(type) {
            const icons = {
                'rg': 'üÜî',
                'cpf': 'üìã',
                'comprovante': 'üè†',
                'renda': 'üí∞',
                'contrato': 'üìù',
                'outro': 'üìÑ'
            };
            return icons[type] || 'üìÑ';
        }

        function displayDocuments() {
            const grid = document.getElementById('documentsGrid');
            
            // Limpar grid e adicionar bot√£o de adicionar
            grid.innerHTML = `
                <div class="add-document" onclick="showDocumentTypes()">
                    <div style="font-size: 2rem; margin-bottom: 8px;">üìé</div>
                    <div style="font-size: 0.8rem; font-weight: 600;">Adicionar Documento</div>
                </div>
            `;

            // Adicionar documentos existentes
            currentDocuments.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'document-item';
                docElement.onclick = () => openDocumentModal(doc);

                docElement.innerHTML = `
                    <div class="document-preview">
                        ${doc.fileType.startsWith('image/') 
                            ? `<img src="${doc.data}" alt="${doc.name}">` 
                            : `<div class="document-icon">üìÑ</div>`
                        }
                    </div>
                    <div class="document-name">${doc.name}</div>
                    <button class="document-remove" onclick="event.stopPropagation(); removeDocument(${doc.id})" title="Remover documento">
                        ‚úï
                    </button>
                `;

                grid.appendChild(docElement);
            });
        }

        function removeDocument(docId) {
            currentDocuments = currentDocuments.filter(doc => doc.id !== docId);
            displayDocuments();
        }

        function openDocumentModal(document) {
            const modal = document.getElementById('documentModal');
            const modalImage = document.getElementById('documentModalImage');
            const modalTitle = document.getElementById('documentModalTitle');
            const modalDescription = document.getElementById('documentModalDescription');
            
            if (document.fileType.startsWith('image/')) {
                modalImage.src = document.data;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            modalTitle.textContent = `${getDocumentIcon(document.type)} ${document.name}`;
            modalDescription.innerHTML = `
                <strong>Arquivo:</strong> ${document.fileName}<br>
                <strong>Tipo:</strong> ${document.fileType}<br>
                <strong>Adicionado em:</strong> ${document.uploadDate}
                ${!document.fileType.startsWith('image/') ? '<br><br>üìÑ Este √© um arquivo PDF que n√£o pode ser visualizado aqui.' : ''}
            `;
            
            modal.classList.add('active');
        }

        function closeDocumentModal() {
            const modal = document.getElementById('documentModal');
            modal.classList.remove('active');
        }

        function clearDocuments() {
            currentDocuments = [];
            displayDocuments();
        }

        // Carregar dados na inicializa√ß√£o
        async function loadAllData() {
            try {
                customers = await lupinDB.loadFromStorage('customers') || [];
                calculationHistory = await lupinDB.loadFromStorage('history') || [];
                allStats = await lupinDB.loadFromStorage('allStats') || [];
                
                // Encontrar ou criar estat√≠sticas do dia atual
                const today = new Date().toDateString();
                let todayStats = allStats.find(stat => stat.date === today);
                
                if (!todayStats) {
                    todayStats = {
                        totalLoaned: 0,
                        totalProfit: 0,
                        totalCalculations: 0,
                        rates: [],
                        date: today,
                        totalReceivable: 0,
                        totalReceived: 0,
                        totalOverdue: 0,
                        overdueCount: 0
                    };
                    allStats.push(todayStats);
                    await lupinDB.saveToStorage('allStats', allStats);
                }
                
                dailyStats = todayStats;
            } catch (error) {
                console.log('Carregando dados do localStorage como fallback');
                // Fallback para localStorage antigo
                calculationHistory = JSON.parse(localStorage.getItem('loanHistory')) || [];
                customers = JSON.parse(localStorage.getItem('customers')) || [];
                const oldStats = JSON.parse(localStorage.getItem('dailyStats'));
                
                if (oldStats) {
                    allStats = [oldStats];
                    dailyStats = oldStats;
                } else {
                    const today = new Date().toDateString();
                    dailyStats = {
                        totalLoaned: 0,
                        totalProfit: 0,
                        totalCalculations: 0,
                        rates: [],
                        date: today,
                        totalReceivable: 0,
                        totalReceived: 0,
                        totalOverdue: 0,
                        overdueCount: 0
                    };
                    allStats = [dailyStats];
                }
                await lupinDB.saveToStorage('allStats', allStats);
            }
        }

        // Fun√ß√µes de exporta√ß√£o e importa√ß√£o
        async function exportData() {
            try {
                const data = await lupinDB.exportAllData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `lupin-cred-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Mostrar confirma√ß√£o
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Exportado!';
                btn.style.background = '#27ae60';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#3498db';
                }, 2000);
            } catch (error) {
                alert('Erro ao exportar dados. Tente novamente.');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (await lupinDB.importAllData(data)) {
                    // Mostrar confirma√ß√£o
                    const btn = document.querySelector('[onclick="document.getElementById(\'importFile\').click()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Importado!';
                    btn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#e67e22';
                    }, 2000);
                } else {
                    alert('Erro ao importar dados. Verifique o arquivo.');
                }
            } catch (error) {
                alert('Arquivo inv√°lido. Selecione um backup v√°lido do Lupin Cred.');
            }
            
            // Limpar input
            event.target.value = '';
        }

        // Fun√ß√£o para calcular juros de atraso
        function calculateOverdueInterest(customer) {
            const dueDate = new Date(customer.dueDate);
            const today = new Date();
            
            if (today <= dueDate) return 0; // N√£o est√° em atraso
            
            const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
            
            // Taxa de juros de atraso: 1% ao dia sobre o valor total
            const overdueRate = 0.01; // 1% ao dia
            const overdueInterest = customer.totalAmount * overdueRate * daysOverdue;
            
            return {
                daysOverdue,
                overdueInterest,
                newTotalAmount: customer.totalAmount + overdueInterest
            };
        }

        // Fun√ß√£o para atualizar todos os empr√©stimos em atraso
        function updateOverdueLoans() {
            let hasOverdue = false;
            
            customers.forEach(customer => {
                if (customer.status === 'active') {
                    const overdueInfo = calculateOverdueInterest(customer);
                    
                    if (overdueInfo.daysOverdue > 0) {
                        customer.overdueInfo = overdueInfo;
                        hasOverdue = true;
                    } else {
                        delete customer.overdueInfo;
                    }
                }
            });
            
            // Mostrar notifica√ß√£o se houver empr√©stimos em atraso
            if (hasOverdue) {
                showOverdueNotification();
            }
            
            return hasOverdue;
        }

        // Fun√ß√£o para mostrar notifica√ß√£o de atraso
        function showOverdueNotification() {
            const overdueCustomers = customers.filter(c => 
                c.status === 'active' && c.overdueInfo && c.overdueInfo.daysOverdue > 0
            );
            
            if (overdueCustomers.length === 0) return;
            
            // Criar ou atualizar elemento de notifica√ß√£o
            let notification = document.getElementById('overdueNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'overdueNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #e74c3c, #c0392b);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
                    z-index: 1000;
                    max-width: 300px;
                    cursor: pointer;
                    animation: slideIn 0.5s ease;
                `;
                document.body.appendChild(notification);
            }
            
            const totalOverdue = overdueCustomers.reduce((sum, c) => sum + c.overdueInfo.overdueInterest, 0);
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <strong>EMPR√âSTIMOS EM ATRASO</strong>
                </div>
                <div style="font-size: 0.9rem;">
                    ${overdueCustomers.length} cliente${overdueCustomers.length > 1 ? 's' : ''} em atraso
                </div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    Juros de atraso: ${formatCurrency(totalOverdue)}
                </div>
                <div style="font-size: 0.7rem; margin-top: 8px; opacity: 0.8;">
                    Clique para ver detalhes
                </div>
            `;
            
            notification.onclick = () => {
                // Scroll para a se√ß√£o de clientes
                document.querySelector('.customers-list').scrollIntoView({ behavior: 'smooth' });
                notification.style.display = 'none';
            };
            
            // Auto-hide ap√≥s 10 segundos
            setTimeout(() => {
                if (notification) {
                    notification.style.display = 'none';
                }
            }, 10000);
        }

        // Reset daily stats if it's a new day
        if (dailyStats.date !== new Date().toDateString()) {
            dailyStats = {
                totalLoaned: 0,
                totalProfit: 0,
                totalCalculations: 0,
                rates: [],
                date: new Date().toDateString(),
                totalReceivable: 0,
                totalReceived: 0,
                totalOverdue: 0,
                overdueCount: 0
            };
            localStorage.setItem('dailyStats', JSON.stringify(dailyStats));
        }

        function setRate(rate) {
            document.getElementById('interestRate').value = rate;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'percent',
                minimumFractionDigits: 2
            }).format(value / 100);
        }

        function formatPhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return `(${cleaned.slice(0,2)}) ${cleaned.slice(2,7)}-${cleaned.slice(7)}`;
            }
            return phone;
        }

        function formatCPF(cpf) {
            const cleaned = cpf.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return `${cleaned.slice(0,3)}.${cleaned.slice(3,6)}.${cleaned.slice(6,9)}-${cleaned.slice(9)}`;
            }
            return cpf;
        }

        function calculateInterest(principal, rate, period, periodType, interestType) {
            let periodInDays = period;
            
            if (periodType === 'months') {
                periodInDays = period * 30;
            } else if (periodType === 'years') {
                periodInDays = period * 365;
            }

            let totalAmount;
            
            if (interestType === 'simple') {
                const interest = principal * (rate / 100) * (periodInDays / 30);
                totalAmount = principal + interest;
            } else {
                const monthlyRate = rate / 100;
                const periods = periodInDays / 30;
                totalAmount = principal * Math.pow(1 + monthlyRate, periods);
            }

            return {
                totalAmount: totalAmount,
                interestEarned: totalAmount - principal,
                profitability: ((totalAmount - principal) / principal) * 100
            };
        }

        function generateComparison(principal, period, periodType, interestType, currentRate) {
            const rates = [15, 20, 25, 30, 35, 40];
            const comparisonData = [];
            
            const currentResult = calculateInterest(principal, currentRate, period, periodType, interestType);
            
            rates.forEach(rate => {
                const result = calculateInterest(principal, rate, period, periodType, interestType);
                const difference = result.totalAmount - currentResult.totalAmount;
                
                comparisonData.push({
                    rate: rate,
                    interest: result.interestEarned,
                    total: result.totalAmount,
                    difference: difference
                });
            });
            
            return comparisonData;
        }

        function displayComparison(comparisonData) {
            const table = document.getElementById('comparisonTable');
            const tbody = document.getElementById('comparisonBody');
            
            tbody.innerHTML = '';
            
            comparisonData.forEach(data => {
                const row = tbody.insertRow();
                const differenceClass = data.difference > 0 ? 'profit-value' : (data.difference < 0 ? 'text-danger' : '');
                const differenceSymbol = data.difference > 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>${data.rate}%</td>
                    <td>${formatCurrency(data.interest)}</td>
                    <td>${formatCurrency(data.total)}</td>
                    <td class="${differenceClass}">${differenceSymbol}${formatCurrency(data.difference)}</td>
                `;
            });
            
            table.style.display = 'table';
        }

        function convertRates() {
            const monthlyRate = parseFloat(document.getElementById('monthlyRate').value);
            if (!monthlyRate) return;
            
            const dailyRate = monthlyRate / 30;
            const yearlyRate = monthlyRate * 12;
            
            document.getElementById('conversionResult').innerHTML = `
                <strong>Di√°ria:</strong> ${dailyRate.toFixed(2)}%<br>
                <strong>Anual:</strong> ${yearlyRate.toFixed(1)}%
            `;
        }

        function calculateDeadline() {
            const startDate = document.getElementById('startDate').value;
            const daysToAdd = parseInt(document.getElementById('daysToAdd').value);
            
            if (!startDate || !daysToAdd) return;
            
            const start = new Date(startDate);
            const end = new Date(start);
            end.setDate(start.getDate() + daysToAdd);
            
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            document.getElementById('deadlineResult').innerHTML = `
                <strong>Vencimento:</strong><br>
                ${end.toLocaleDateString('pt-BR', options)}
            `;
        }

        let selectedCustomerId = null;

        function showCustomerSelection() {
            if (currentCalculation) {
                document.getElementById('customerSelectionSection').style.display = 'block';
                document.getElementById('loanActions').style.display = 'none';
                selectedCustomerId = null;
            }
        }

        function hideCustomerSelection() {
            document.getElementById('customerSelectionSection').style.display = 'none';
            document.getElementById('existingCustomersSection').style.display = 'none';
            document.getElementById('newCustomerSection').style.display = 'none';
            document.getElementById('loanActions').style.display = 'block';
            selectedCustomerId = null;
        }

        function showExistingCustomers() {
            document.getElementById('existingCustomersSection').style.display = 'block';
            document.getElementById('newCustomerSection').style.display = 'none';
            loadExistingCustomers();
        }

        function showNewCustomerForm() {
            document.getElementById('existingCustomersSection').style.display = 'none';
            document.getElementById('newCustomerSection').style.display = 'block';
            showCustomerForm();
        }

        function loadExistingCustomers() {
            const container = document.getElementById('existingCustomersList');
            
            // Obter todos os clientes √∫nicos (incluindo os que j√° pagaram)
            const allCustomers = [...new Map(customers.map(c => [c.name.toLowerCase() + c.phone, c])).values()];
            
            if (allCustomers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                        <p>Nenhum cliente cadastrado ainda</p>
                        <p style="font-size: 0.8rem; opacity: 0.8;">Cadastre um novo cliente para come√ßar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allCustomers.map(customer => {
                const activeLoans = customers.filter(c => 
                    c.name.toLowerCase() === customer.name.toLowerCase() && 
                    c.phone === customer.phone && 
                    c.status === 'active'
                ).length;
                
                const totalLoans = customers.filter(c => 
                    c.name.toLowerCase() === customer.name.toLowerCase() && 
                    c.phone === customer.phone
                ).length;

                const photoHtml = customer.photo 
                    ? `<img src="${customer.photo}" alt="Foto de ${customer.name}" class="customer-selection-photo">`
                    : `<div class="customer-selection-placeholder">üë§</div>`;

                return `
                    <div class="customer-selection-item" onclick="selectCustomer(${customer.id}, '${customer.name}', '${customer.phone}')">
                        ${photoHtml}
                        <div class="customer-selection-info">
                            <div class="customer-selection-name">${customer.name}</div>
                            <div class="customer-selection-details">
                                üì± ${formatPhone(customer.phone)}
                                ${customer.cpf ? `‚Ä¢ üìÑ ${formatCPF(customer.cpf)}` : ''}
                            </div>
                            <div class="customer-selection-details">
                                üìä ${totalLoans} empr√©stimo${totalLoans > 1 ? 's' : ''} total
                                ${activeLoans > 0 ? `‚Ä¢ ${activeLoans} ativo${activeLoans > 1 ? 's' : ''}` : '‚Ä¢ Sem empr√©stimos ativos'}
                            </div>
                        </div>
                        <div class="customer-selection-status ${activeLoans > 0 ? 'status-active' : 'status-paid'}">
                            ${activeLoans > 0 ? `${activeLoans} Ativo${activeLoans > 1 ? 's' : ''}` : 'Livre'}
                        </div>
                    </div>
                `;
            }).join('') + `
                <button class="confirm-selection-btn" id="confirmSelectionBtn" onclick="confirmCustomerSelection()">
                    ‚úÖ Emprestar para Cliente Selecionado
                </button>
            `;
        }

        function selectCustomer(customerId, customerName, customerPhone) {
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.customer-selection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Adicionar sele√ß√£o atual
            event.currentTarget.classList.add('selected');
            
            // Armazenar cliente selecionado
            selectedCustomerId = customerId;
            
            // Habilitar bot√£o de confirma√ß√£o
            const confirmBtn = document.getElementById('confirmSelectionBtn');
            confirmBtn.classList.add('enabled');
            confirmBtn.innerHTML = `‚úÖ Emprestar ${formatCurrency(currentCalculation.totalAmount)} para ${customerName}`;
        }

        function confirmCustomerSelection() {
            if (!selectedCustomerId) return;
            
            const selectedCustomer = customers.find(c => c.id === selectedCustomerId);
            if (!selectedCustomer) return;
            
            // Criar novo empr√©stimo usando dados do cliente existente
            const newLoan = {
                id: Date.now(),
                name: selectedCustomer.name,
                phone: selectedCustomer.phone,
                cpf: selectedCustomer.cpf || '',
                address: selectedCustomer.address || '',
                photo: selectedCustomer.photo || null,
                documents: selectedCustomer.documents || [],
                ...currentCalculation,
                loanDate: new Date().toLocaleDateString('pt-BR'),
                status: 'active'
            };
            
            // Definir data de vencimento (30 dias por padr√£o)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            newLoan.dueDate = dueDate.toISOString().split('T')[0];
            
            // Adicionar √† lista de clientes
            customers.unshift(newLoan);
            lupinDB.saveToStorage('customers', customers);
            
            // Atualizar estat√≠sticas
            dailyStats.totalReceivable += newLoan.totalAmount;
            const index = allStats.findIndex(stat => stat.date === dailyStats.date);
            if (index !== -1) {
                allStats[index] = dailyStats;
            }
            lupinDB.saveToStorage('allStats', allStats);
            
            // Atualizar displays
            displayCustomers();
            updateDailyStats(currentCalculation);
            
            // Esconder se√ß√£o de sele√ß√£o
            hideCustomerSelection();
            
            // Mostrar mensagem de sucesso
            const btn = document.querySelector('.loan-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `‚úÖ Novo Empr√©stimo para ${selectedCustomer.name}!`;
            btn.style.background = '#27ae60';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                document.getElementById('loanActions').style.display = 'block';
            }, 3000);
        }

        function showCustomerForm() {
            if (currentCalculation) {
                document.getElementById('customerSection').style.display = 'block';
                document.getElementById('customerSelectionSection').style.display = 'none';
                document.getElementById('loanActions').style.display = 'none';
                
                // Set default due date (30 days from today)
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            }
        }

        function hideCustomerForm() {
            document.getElementById('customerSection').style.display = 'none';
            document.getElementById('customerSelectionSection').style.display = 'block';
            
            // Limpar foto e documentos ao cancelar
            removePhoto();
            clearDocuments();
        }

        async function addCustomer(customerData) {
            const customer = {
                id: Date.now(),
                ...customerData,
                loanDate: new Date().toLocaleDateString('pt-BR'),
                status: 'active',
                photo: currentPhotoData, // Adicionar foto aos dados do cliente
                documents: [...currentDocuments] // Adicionar documentos aos dados do cliente
            };
            
            customers.unshift(customer);
            await lupinDB.saveToStorage('customers', customers);
            
            // Atualizar estat√≠sticas - adicionar aos receb√≠veis
            dailyStats.totalReceivable += customer.totalAmount;
            
            // Atualizar estat√≠sticas no array principal
            const index = allStats.findIndex(stat => stat.date === dailyStats.date);
            if (index !== -1) {
                allStats[index] = dailyStats;
            }
            await lupinDB.saveToStorage('allStats', allStats);
            
            displayCustomers();
            updateDailyStats(currentCalculation);
        }

        function displayCustomers() {
            const container = document.getElementById('customersContainer');
            
            if (customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum cliente cadastrado ainda</p>';
                return;
            }
            
            const activeCustomers = customers.filter(c => c.status === 'active');
            
            if (activeCustomers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Todos os empr√©stimos foram quitados</p>';
                return;
            }
            
            // Atualizar informa√ß√µes de atraso antes de exibir
            updateOverdueLoans();
            
            container.innerHTML = activeCustomers.map(customer => {
                const dueDate = new Date(customer.dueDate);
                const today = new Date();
                const isOverdue = dueDate < today;
                const dueDateClass = isOverdue ? 'overdue' : '';
                
                // Calcular informa√ß√µes de atraso
                const overdueInfo = customer.overdueInfo;
                let currentAmount = customer.totalAmount;
                let overdueDisplay = '';
                
                if (overdueInfo && overdueInfo.daysOverdue > 0) {
                    currentAmount = overdueInfo.newTotalAmount;
                    overdueDisplay = `
                        <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #dc3545;">
                            <div style="font-weight: 600; margin-bottom: 5px;">üö® EMPR√âSTIMO EM ATRASO</div>
                            <div style="font-size: 0.8rem;">
                                ‚Ä¢ ${overdueInfo.daysOverdue} dia${overdueInfo.daysOverdue > 1 ? 's' : ''} de atraso<br>
                                ‚Ä¢ Juros de atraso: ${formatCurrency(overdueInfo.overdueInterest)} (1% ao dia)<br>
                                ‚Ä¢ <strong>Novo valor total: ${formatCurrency(overdueInfo.newTotalAmount)}</strong>
                            </div>
                        </div>
                    `;
                }
                
                // Verificar se tem foto
                const photoHtml = customer.photo 
                    ? `<img src="${customer.photo}" alt="Foto de ${customer.name}" class="customer-photo" onclick="openPhotoModal('${customer.photo}')">`
                    : `<div class="customer-photo" style="background: #e9ecef; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 1.5rem;">üë§</div>`;
                
                return `
                    <div class="customer-card" style="${isOverdue ? 'border-left-color: #dc3545; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);' : ''}">
                        <div class="customer-header-with-photo">
                            ${photoHtml}
                            <div class="customer-info-section">
                                <div class="customer-header">
                                    <div class="customer-name">${customer.name} ${isOverdue ? '‚ö†Ô∏è' : ''}</div>
                                    <div class="customer-debt" style="${isOverdue ? 'color: #dc3545; font-weight: 700;' : ''}">${formatCurrency(currentAmount)}</div>
                                </div>
                                
                                <div class="customer-info">
                                    üì± ${formatPhone(customer.phone)}
                                    ${customer.cpf ? `‚Ä¢ üìÑ ${formatCPF(customer.cpf)}` : ''}
                                </div>
                                
                                ${customer.address ? `<div class="customer-info">üìç ${customer.address}</div>` : ''}
                                
                                <div class="customer-info">
                                    üí∞ Emprestado: ${formatCurrency(customer.principal)} ‚Ä¢ 
                                    üìà Juros: ${formatCurrency(customer.interestEarned)} (${customer.rate}%)
                                </div>
                                
                                <div class="due-date ${dueDateClass}">
                                    ${isOverdue ? '‚ö†Ô∏è Vencido em' : 'üìÖ Vence em'} ${dueDate.toLocaleDateString('pt-BR')}
                                </div>
                                
                                ${overdueDisplay}
                            </div>
                        </div>
                        
                        ${customer.paymentHistory && customer.paymentHistory.length > 0 ? `
                            <div class="payment-history">
                                <h4>üí∞ Hist√≥rico de Pagamentos (${customer.paymentHistory.length})</h4>
                                ${customer.paymentHistory.slice(-3).reverse().map(payment => `
                                    <div class="payment-history-item">
                                        <div class="payment-date">üìÖ ${payment.date}</div>
                                        <div class="payment-details">
                                            <span>${payment.type} ${payment.note ? `- ${payment.note}` : ''}</span>
                                            <span class="payment-amount">${formatCurrency(payment.amount)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                                ${customer.paymentHistory.length > 3 ? `
                                    <div style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #6c757d;">
                                        ... e mais ${customer.paymentHistory.length - 3} pagamento${customer.paymentHistory.length - 3 > 1 ? 's' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${customer.documents && customer.documents.length > 0 ? `
                            <div class="customer-documents">
                                <h4>üìÑ Documentos (${customer.documents.length})</h4>
                                <div class="customer-docs-grid">
                                    ${customer.documents.map(doc => `
                                        <div class="customer-doc-item" onclick="openDocumentModal(${JSON.stringify(doc).replace(/"/g, '&quot;')})">
                                            <div class="customer-doc-preview">
                                                ${doc.fileType.startsWith('image/') 
                                                    ? `<img src="${doc.data}" alt="${doc.name}">` 
                                                    : `<div style="font-size: 1.5rem; color: #6c757d;">${getDocumentIcon(doc.type)}</div>`
                                                }
                                            </div>
                                            <div class="customer-doc-name">${doc.name}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="customer-actions">
                            <button class="action-btn paid-btn" onclick="showPaymentOptions(${customer.id}, ${currentAmount}, '${customer.name}')">
                                üí∞ Receber Pagamento
                            </button>
                            <button class="action-btn contact-btn" onclick="contactCustomer('${customer.phone}', '${customer.name}', ${currentAmount}, ${overdueInfo ? overdueInfo.daysOverdue : 0})">
                                üì± Contatar
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteCustomer(${customer.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Vari√°veis globais para o modal de pagamento
        let currentPaymentCustomer = null;

        function showPaymentOptions(customerId, currentAmount, customerName) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            currentPaymentCustomer = customer;
            
            // Calcular valores
            const originalAmount = customer.totalAmount;
            const overdueInfo = customer.overdueInfo || { overdueInterest: 0 };
            const totalAmount = currentAmount;
            const interestOnly = customer.interestEarned + overdueInfo.overdueInterest;
            
            // Preencher modal
            document.getElementById('paymentModalTitle').textContent = `üí∞ Receber Pagamento - ${customerName}`;
            document.getElementById('originalAmount').textContent = formatCurrency(originalAmount);
            document.getElementById('overdueAmount').textContent = formatCurrency(overdueInfo.overdueInterest);
            document.getElementById('currentTotalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('fullPaymentAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('interestPaymentAmount').textContent = formatCurrency(interestOnly);
            
            // Mostrar modal
            document.getElementById('paymentModal').classList.add('active');
            
            // Esconder se√ß√£o de pagamento personalizado
            document.getElementById('customPaymentSection').style.display = 'none';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('customPaymentSection').style.display = 'none';
            document.getElementById('customAmount').value = '';
            document.getElementById('paymentNote').value = '';
            currentPaymentCustomer = null;
        }

        function showCustomPayment() {
            document.getElementById('customPaymentSection').style.display = 'block';
            document.getElementById('customAmount').focus();
        }

        async function processFullPayment() {
            if (!currentPaymentCustomer) return;
            
            const customer = currentPaymentCustomer;
            const overdueInfo = customer.overdueInfo || { overdueInterest: 0 };
            const finalAmount = customer.totalAmount + overdueInfo.overdueInterest;
            
            // Adicionar ao hist√≥rico de pagamentos
            if (!customer.paymentHistory) customer.paymentHistory = [];
            customer.paymentHistory.push({
                date: new Date().toLocaleDateString('pt-BR'),
                type: 'Pagamento Total',
                amount: finalAmount,
                note: 'Empr√©stimo quitado completamente'
            });
            
            // Marcar como pago
            customer.status = 'paid';
            customer.paidDate = new Date().toLocaleDateString('pt-BR');
            customer.finalAmount = finalAmount;
            customer.totalProfitEarned = customer.interestEarned + overdueInfo.overdueInterest;
            
            // Atualizar estat√≠sticas
            dailyStats.totalReceivable -= customer.totalAmount;
            dailyStats.totalReceived += finalAmount;
            
            if (customer.overdueInfo) {
                dailyStats.totalOverdue -= customer.overdueInfo.overdueInterest;
                dailyStats.overdueCount -= 1;
            }
            
            await saveAndUpdate();
            closePaymentModal();
            
            showPaymentSuccess(`‚úÖ Empr√©stimo Quitado!`, `${customer.name} pagou ${formatCurrency(finalAmount)}`);
        }

        async function processInterestPayment() {
            if (!currentPaymentCustomer) return;
            
            const customer = currentPaymentCustomer;
            const overdueInfo = customer.overdueInfo || { overdueInterest: 0 };
            const interestAmount = customer.interestEarned + overdueInfo.overdueInterest;
            
            // Adicionar ao hist√≥rico de pagamentos
            if (!customer.paymentHistory) customer.paymentHistory = [];
            customer.paymentHistory.push({
                date: new Date().toLocaleDateString('pt-BR'),
                type: 'Pagamento de Juros',
                amount: interestAmount,
                note: 'Pagamento apenas dos juros'
            });
            
            // Atualizar valor do empr√©stimo (remover juros pagos)
            customer.totalAmount = customer.principal; // Volta para o valor original
            customer.interestEarned = 0; // Zerar juros j√° pagos
            
            // Limpar informa√ß√µes de atraso
            if (customer.overdueInfo) {
                dailyStats.totalOverdue -= customer.overdueInfo.overdueInterest;
                dailyStats.overdueCount -= 1;
                delete customer.overdueInfo;
            }
            
            // Atualizar estat√≠sticas
            dailyStats.totalReceived += interestAmount;
            
            // Renovar data de vencimento (mais 30 dias)
            const newDueDate = new Date();
            newDueDate.setDate(newDueDate.getDate() + 30);
            customer.dueDate = newDueDate.toISOString().split('T')[0];
            
            await saveAndUpdate();
            closePaymentModal();
            
            showPaymentSuccess(`üìà Juros Recebidos!`, `${customer.name} pagou ${formatCurrency(interestAmount)} de juros. Empr√©stimo renovado por mais 30 dias.`);
        }

        async function processCustomPayment() {
            if (!currentPaymentCustomer) return;
            
            const customAmount = parseFloat(document.getElementById('customAmount').value);
            const note = document.getElementById('paymentNote').value || 'Pagamento personalizado';
            
            if (!customAmount || customAmount <= 0) {
                alert('Por favor, insira um valor v√°lido.');
                return;
            }
            
            const customer = currentPaymentCustomer;
            const overdueInfo = customer.overdueInfo || { overdueInterest: 0 };
            const totalOwed = customer.totalAmount + overdueInfo.overdueInterest;
            
            // Adicionar ao hist√≥rico de pagamentos
            if (!customer.paymentHistory) customer.paymentHistory = [];
            customer.paymentHistory.push({
                date: new Date().toLocaleDateString('pt-BR'),
                type: 'Pagamento Parcial',
                amount: customAmount,
                note: note
            });
            
            // Verificar se quitou completamente
            if (customAmount >= totalOwed) {
                // Pagamento total
                customer.status = 'paid';
                customer.paidDate = new Date().toLocaleDateString('pt-BR');
                customer.finalAmount = customAmount;
                customer.totalProfitEarned = customer.interestEarned + overdueInfo.overdueInterest;
                
                dailyStats.totalReceivable -= customer.totalAmount;
                
                if (customer.overdueInfo) {
                    dailyStats.totalOverdue -= customer.overdueInfo.overdueInterest;
                    dailyStats.overdueCount -= 1;
                }
            } else {
                // Pagamento parcial - reduzir valor devido
                const remainingAmount = totalOwed - customAmount;
                
                // Se pagou mais que os juros, reduzir do principal tamb√©m
                if (customAmount > (customer.interestEarned + overdueInfo.overdueInterest)) {
                    const principalPayment = customAmount - (customer.interestEarned + overdueInfo.overdueInterest);
                    customer.principal -= principalPayment;
                    customer.totalAmount = customer.principal + customer.interestEarned;
                    customer.interestEarned = 0;
                } else {
                    // Pagou apenas parte dos juros
                    const newInterest = Math.max(0, (customer.interestEarned + overdueInfo.overdueInterest) - customAmount);
                    customer.interestEarned = newInterest;
                    customer.totalAmount = customer.principal + newInterest;
                }
                
                // Limpar atraso se foi pago
                if (customer.overdueInfo && customAmount >= overdueInfo.overdueInterest) {
                    dailyStats.totalOverdue -= customer.overdueInfo.overdueInterest;
                    dailyStats.overdueCount -= 1;
                    delete customer.overdueInfo;
                }
            }
            
            // Atualizar estat√≠sticas
            dailyStats.totalReceived += customAmount;
            
            await saveAndUpdate();
            closePaymentModal();
            
            const message = customer.status === 'paid' 
                ? `‚úÖ Empr√©stimo Quitado!` 
                : `üíµ Pagamento Parcial Recebido!`;
            const details = customer.status === 'paid'
                ? `${customer.name} quitou completamente o empr√©stimo`
                : `${customer.name} pagou ${formatCurrency(customAmount)}. Restam ${formatCurrency(customer.totalAmount)}`;
                
            showPaymentSuccess(message, details);
        }

        async function saveAndUpdate() {
            await lupinDB.saveToStorage('customers', customers);
            
            const index = allStats.findIndex(stat => stat.date === dailyStats.date);
            if (index !== -1) {
                allStats[index] = dailyStats;
            }
            await lupinDB.saveToStorage('allStats', allStats);
            
            displayCustomers();
            displayDailyStats();
        }

        function showPaymentSuccess(title, message) {
            // Criar notifica√ß√£o de sucesso
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
                z-index: 1001;
                max-width: 350px;
                animation: slideIn 0.5s ease;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">${title}</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function contactCustomer(phone, name, amount, daysOverdue = 0) {
            const cleanPhone = phone.replace(/\D/g, '');
            let message;
            
            if (daysOverdue > 0) {
                message = `üö® URGENTE - ${name}! Seu empr√©stimo est√° em atraso h√° ${daysOverdue} dia${daysOverdue > 1 ? 's' : ''}. Valor atual: ${formatCurrency(amount)} (incluindo juros de atraso de 1% ao dia). Entre em contato IMEDIATAMENTE para regularizar. Obrigado!`;
            } else {
                message = `Ol√° ${name}! Lembrete sobre seu empr√©stimo no valor de ${formatCurrency(amount)}. Entre em contato para acertarmos. Obrigado!`;
            }
            
            const whatsappUrl = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        async function deleteCustomer(customerId) {
            customers = customers.filter(c => c.id !== customerId);
            await lupinDB.saveToStorage('customers', customers);
            displayCustomers();
        }

        async function clearCustomers() {
            customers = [];
            await lupinDB.saveToStorage('customers', []);
            displayCustomers();
        }

        async function updateDailyStats(calculation) {
            dailyStats.totalLoaned += calculation.principal;
            dailyStats.totalProfit += calculation.interestEarned;
            dailyStats.totalCalculations += 1;
            dailyStats.rates.push(calculation.rate);
            
            // Atualizar no array de todas as estat√≠sticas
            const index = allStats.findIndex(stat => stat.date === dailyStats.date);
            if (index !== -1) {
                allStats[index] = dailyStats;
            }
            
            await lupinDB.saveToStorage('allStats', allStats);
            displayDailyStats();
        }

        function displayDailyStats(statsToShow = null) {
            const stats = statsToShow || dailyStats;
            
            // Calcular estat√≠sticas em tempo real dos empr√©stimos ativos
            const activeCustomers = customers.filter(c => c.status === 'active');
            const paidCustomers = customers.filter(c => c.status === 'paid');
            
            let currentReceivable = 0;
            let currentOverdue = 0;
            let overdueCount = 0;
            
            activeCustomers.forEach(customer => {
                const overdueInfo = calculateOverdueInterest(customer);
                if (overdueInfo && overdueInfo.daysOverdue > 0) {
                    currentReceivable += overdueInfo.newTotalAmount;
                    currentOverdue += overdueInfo.overdueInterest;
                    overdueCount++;
                } else {
                    currentReceivable += customer.totalAmount;
                }
            });
            
            const currentReceived = paidCustomers.reduce((sum, c) => sum + (c.finalAmount || c.totalAmount), 0);
            
            document.getElementById('totalLoaned').textContent = formatCurrency(stats.totalLoaned);
            document.getElementById('totalProfit').textContent = formatCurrency(currentReceived - stats.totalLoaned);
            document.getElementById('totalCalculations').textContent = stats.totalCalculations;
            
            const avgRate = stats.rates && stats.rates.length > 0 
                ? stats.rates.reduce((a, b) => a + b, 0) / stats.rates.length 
                : 0;
            document.getElementById('avgRate').textContent = avgRate.toFixed(1) + '%';
            
            // Atualizar os novos campos se existirem
            const receivableElement = document.getElementById('totalReceivable');
            const receivedElement = document.getElementById('totalReceived');
            const overdueElement = document.getElementById('totalOverdue');
            const overdueCountElement = document.getElementById('overdueCount');
            
            if (receivableElement) receivableElement.textContent = formatCurrency(currentReceivable);
            if (receivedElement) receivedElement.textContent = formatCurrency(currentReceived);
            if (overdueElement) overdueElement.textContent = formatCurrency(currentOverdue);
            if (overdueCountElement) overdueCountElement.textContent = overdueCount;
        }

        function filterStatistics() {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione as datas inicial e final');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('A data inicial deve ser anterior √† data final');
                return;
            }
            
            // Filtrar estat√≠sticas por per√≠odo
            const filteredStats = allStats.filter(stat => {
                const statDate = new Date(stat.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                return statDate >= start && statDate <= end;
            });
            
            // Consolidar estat√≠sticas do per√≠odo
            const consolidatedStats = {
                totalLoaned: 0,
                totalProfit: 0,
                totalCalculations: 0,
                rates: []
            };
            
            filteredStats.forEach(stat => {
                consolidatedStats.totalLoaned += stat.totalLoaned || 0;
                consolidatedStats.totalProfit += stat.totalProfit || 0;
                consolidatedStats.totalCalculations += stat.totalCalculations || 0;
                if (stat.rates && stat.rates.length > 0) {
                    consolidatedStats.rates.push(...stat.rates);
                }
            });
            
            // Mostrar estat√≠sticas consolidadas
            displayDailyStats(consolidatedStats);
            
            // Mostrar informa√ß√£o do per√≠odo
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            const dateRangeText = document.getElementById('dateRangeText');
            
            const startFormatted = new Date(startDate).toLocaleDateString('pt-BR');
            const endFormatted = new Date(endDate).toLocaleDateString('pt-BR');
            
            dateRangeText.textContent = `${startFormatted} at√© ${endFormatted}`;
            dateRangeInfo.style.display = 'block';
            
            currentStatsFilter = { startDate, endDate, stats: consolidatedStats };
        }

        function clearDateFilter() {
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('dateRangeInfo').style.display = 'none';
            
            // Voltar para estat√≠sticas do dia atual
            displayDailyStats();
            currentStatsFilter = null;
        }

        async function resetStatistics() {
            const confirmReset = confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso ir√° apagar TODAS as estat√≠sticas salvas permanentemente.\n\nTem certeza que deseja continuar?');
            
            if (confirmReset) {
                const doubleConfirm = confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nTodos os dados de estat√≠sticas ser√£o perdidos para sempre.\n\nConfirma o reset completo?');
                
                if (doubleConfirm) {
                    // Reset completo das estat√≠sticas
                    const today = new Date().toDateString();
                    dailyStats = {
                        totalLoaned: 0,
                        totalProfit: 0,
                        totalCalculations: 0,
                        rates: [],
                        date: today
                    };
                    
                    allStats = [dailyStats];
                    await lupinDB.saveToStorage('allStats', allStats);
                    
                    // Limpar filtros
                    clearDateFilter();
                    
                    // Mostrar confirma√ß√£o
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Resetado!';
                    btn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#e74c3c';
                    }, 2000);
                }
            }
        }

        async function addToHistory(calculation) {
            calculation.id = Date.now(); // Adicionar ID √∫nico
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 10) {
                calculationHistory = calculationHistory.slice(0, 10);
            }
            await lupinDB.saveToStorage('history', calculationHistory);
            displayHistory();
        }

        function displayHistory() {
            const container = document.getElementById('historyContainer');
            
            if (calculationHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum c√°lculo realizado ainda</p>';
                return;
            }
            
            container.innerHTML = calculationHistory.map(calc => `
                <div class="history-item">
                    <div>
                        <strong>${formatCurrency(calc.principal)}</strong> a <strong>${calc.rate}%</strong> por <strong>${calc.period} ${calc.periodType}</strong>
                        <br>
                        <small style="color: #6c757d;">${calc.interestType === 'simple' ? 'Juros Simples' : 'Juros Compostos'} - ${calc.date}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #27ae60; font-weight: 600;">${formatCurrency(calc.totalAmount)}</div>
                        <small style="color: #6c757d;">Lucro: ${formatCurrency(calc.interestEarned)}</small>
                    </div>
                </div>
            `).join('');
        }

        async function clearHistory() {
            calculationHistory = [];
            await lupinDB.saveToStorage('history', []);
            displayHistory();
        }

        // Event Listeners
        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('interestRate').value);
            const period = parseInt(document.getElementById('period').value);
            const periodType = document.getElementById('periodType').value;
            const interestType = document.getElementById('interestType').value;
            
            if (!principal || !rate || !period) {
                return;
            }
            
            const result = calculateInterest(principal, rate, period, periodType, interestType);
            
            // Display results
            document.getElementById('totalAmount').textContent = formatCurrency(result.totalAmount);
            document.getElementById('interestEarned').textContent = formatCurrency(result.interestEarned);
            document.getElementById('profitability').textContent = formatPercentage(result.profitability);
            
            // Generate and display comparison
            const comparisonData = generateComparison(principal, period, periodType, interestType, rate);
            displayComparison(comparisonData);
            
            // Store current calculation
            currentCalculation = {
                principal: principal,
                rate: rate,
                period: period,
                periodType: periodType,
                interestType: interestType,
                totalAmount: result.totalAmount,
                interestEarned: result.interestEarned,
                profitability: result.profitability,
                date: new Date().toLocaleDateString('pt-BR')
            };
            
            // Add to history (always)
            addToHistory(currentCalculation);
            
            // Show loan confirmation button
            document.getElementById('loanActions').style.display = 'block';
        });

        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                cpf: document.getElementById('customerCpf').value,
                address: document.getElementById('customerAddress').value,
                dueDate: document.getElementById('dueDate').value,
                ...currentCalculation
            };
            
            addCustomer(customerData);
            
            // Reset form and hide section
            document.getElementById('customerForm').reset();
            document.getElementById('customerSection').style.display = 'none';
            document.getElementById('loanActions').style.display = 'none';
            
            // Limpar foto e documentos
            removePhoto();
            clearDocuments();
            
            // Show success message
            const btn = document.querySelector('.loan-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Cliente Cadastrado com Sucesso!';
            btn.style.background = '#27ae60';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                document.getElementById('loanActions').style.display = 'block';
            }, 3000);
        });

        // Auto-format phone input
        document.getElementById('customerPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length > 6) {
                    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                }
                e.target.value = value;
            }
        });

        // Auto-format CPF input
        document.getElementById('customerCpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
                e.target.value = value;
            }
        });

        // Set today's date as default
        document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
        
        // Set default dates for statistics filter (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('endDateFilter').value = today.toISOString().split('T')[0];
        document.getElementById('startDateFilter').value = thirtyDaysAgo.toISOString().split('T')[0];

        // Load data on page load
        window.addEventListener('load', async () => {
            await loadAllData();
            displayHistory();
            displayDailyStats();
            displayCustomers();
            
            // Verificar empr√©stimos em atraso a cada 30 segundos
            setInterval(() => {
                if (customers.length > 0) {
                    updateOverdueLoans();
                    displayDailyStats();
                }
            }, 30000);
            
            // Verifica√ß√£o inicial de atraso
            setTimeout(() => {
                updateOverdueLoans();
            }, 2000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'991953d0011a009f',t:'MTc2MDk3MTgyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
