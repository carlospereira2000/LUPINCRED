<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lupin Cred - Calculadora de Juros Profissional</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        html {
            height: 100%;
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .container {
            max-width: calc(100vw - 10px);
            width: calc(100vw - 10px);
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 10px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.8rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        .calculator-section {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.85rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .preset-btn {
            padding: 6px 8px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: #3498db;
            color: white;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .results {
            background: white;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .result-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }

        .result-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .result-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .profit-value {
            color: #27ae60;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.7rem;
        }

        .comparison-table th {
            background: #3498db;
            color: white;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .comparison-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.7rem;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .history-section {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .history-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .clear-history {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .clear-history:hover {
            background: #c0392b;
        }

        .tips-section {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            width: 100%;
            max-width: 100%;
        }

        .advanced-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .advanced-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .advanced-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: white;
        }

        .conversion-controls, .deadline-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .conversion-controls input, .deadline-controls input {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
        }

        .conversion-controls input::placeholder, .deadline-controls input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .convert-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .convert-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .conversion-result {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
            text-align: center;
            min-height: 20px;
        }

        .loan-actions {
            margin-top: 15px;
        }

        .loan-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .loan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
        }

        .statistics-section {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 3px solid #3498db;
        }

        .stat-icon {
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 50%;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 500;
        }

        .customer-section {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            width: 100%;
            max-width: 100%;
        }

        .customer-section input, .customer-section textarea {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
        }

        .customer-section input::placeholder, .customer-section textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .customer-section label {
            color: white;
        }

        .customers-list {
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: 100%;
        }

        .customer-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .customer-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .customer-debt {
            font-size: 1rem;
            font-weight: 600;
            color: #e74c3c;
        }

        .customer-info {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .due-date {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }

        .overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .customer-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .paid-btn {
            background: #27ae60;
            color: white;
        }

        .paid-btn:hover {
            background: #219a52;
        }

        .contact-btn {
            background: #3498db;
            color: white;
        }

        .contact-btn:hover {
            background: #2980b9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-row-full {
            grid-column: 1 / -1;
        }

        .header h1 {
            font-size: 2rem;
        }
        
        .preset-buttons {
            grid-template-columns: repeat(2, 1fr);
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    </style>
</head>
<body>
    <main class="container">
        <header class="header">
            <h1>üí∞ Lupin Cred</h1>
            <p>Calculadora de Juros Profissional - Gerencie seus empr√©stimos com precis√£o</p>
        </header>

        <div class="main-content">
            <section class="calculator-section" style="position: relative;">
                <div id="saveIndicator" style="position: absolute; top: 10px; right: 10px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.7rem; opacity: 0; transition: opacity 0.3s;">
                    üíæ Dados Salvos
                </div>
                <h2 class="section-title">
                    üßÆ Calculadora Principal
                </h2>
                
                <form id="loanForm">
                    <div class="form-group">
                        <label for="principal">Valor do Empr√©stimo (R$)</label>
                        <input type="number" id="principal" step="0.01" min="0" placeholder="Ex: 1000.00" required>
                    </div>

                    <div class="form-group">
                        <label for="interestRate">Taxa de Juros (%)</label>
                        <input type="number" id="interestRate" step="0.1" min="0" placeholder="Ex: 30.0" required>
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn" onclick="setRate(15)">15%</button>
                            <button type="button" class="preset-btn" onclick="setRate(20)">20%</button>
                            <button type="button" class="preset-btn" onclick="setRate(25)">25%</button>
                            <button type="button" class="preset-btn" onclick="setRate(30)">30%</button>
                            <button type="button" class="preset-btn" onclick="setRate(35)">35%</button>
                            <button type="button" class="preset-btn" onclick="setRate(40)">40%</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="period">Per√≠odo</label>
                        <input type="number" id="period" min="1" placeholder="Ex: 30" required>
                    </div>

                    <div class="form-group">
                        <label for="periodType">Tipo de Per√≠odo</label>
                        <select id="periodType" required>
                            <option value="days">Dias</option>
                            <option value="months">Meses</option>
                            <option value="years">Anos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="interestType">Tipo de Juros</label>
                        <select id="interestType" required>
                            <option value="simple">Juros Simples</option>
                            <option value="compound">Juros Compostos</option>
                        </select>
                    </div>

                    <button type="submit" class="calculate-btn">
                        üìä Calcular Empr√©stimo
                    </button>
                    
                    <div class="loan-actions" style="display: none;" id="loanActions">
                        <button type="button" class="loan-btn" onclick="showCustomerForm()">
                            üë§ Cadastrar Cliente e Emprestar
                        </button>
                    </div>
                </form>
            </section>

            <section class="results">
                <h2 class="section-title">
                    üìà Resultados
                </h2>
                
                <div id="resultsContainer">
                    <div class="result-card">
                        <div class="result-label">Valor Total a Receber</div>
                        <div class="result-value" id="totalAmount">R$ 0,00</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">Juros Ganhos</div>
                        <div class="result-value profit-value" id="interestEarned">R$ 0,00</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-label">Rentabilidade</div>
                        <div class="result-value" id="profitability">0%</div>
                    </div>
                </div>

                <table class="comparison-table" id="comparisonTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Taxa</th>
                            <th>Juros</th>
                            <th>Total</th>
                            <th>Diferen√ßa</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                    </tbody>
                </table>
            </section>

            <section class="customer-section" id="customerSection" style="display: none;">
                <h2 class="section-title" style="color: white;">
                    üë§ Cadastro do Cliente
                </h2>
                
                <form id="customerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Nome Completo *</label>
                            <input type="text" id="customerName" placeholder="Ex: Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Celular *</label>
                            <input type="tel" id="customerPhone" placeholder="(11) 99999-9999" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerCpf">CPF (opcional)</label>
                            <input type="text" id="customerCpf" placeholder="000.000.000-00">
                        </div>
                        <div class="form-group">
                            <label for="dueDate">Data de Cobran√ßa *</label>
                            <input type="date" id="dueDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerAddress">Endere√ßo (opcional)</label>
                        <textarea id="customerAddress" placeholder="Rua, n√∫mero, bairro, cidade..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="calculate-btn" style="flex: 1;">
                            ‚úÖ Confirmar Empr√©stimo
                        </button>
                        <button type="button" class="clear-history" onclick="hideCustomerForm()" style="flex: 0 0 auto;">
                            Cancelar
                        </button>
                    </div>
                </form>
            </section>

            <section class="customers-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">
                        üë• Clientes Ativos
                    </h2>
                    <button class="clear-history" onclick="clearCustomers()">Limpar Todos</button>
                </div>
                <div id="customersContainer">
                    <p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum cliente cadastrado ainda</p>
                </div>
            </section>

            <section class="history-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">
                        üìã Hist√≥rico de C√°lculos
                    </h2>
                    <button class="clear-history" onclick="clearHistory()">Limpar Hist√≥rico</button>
                </div>
                <div id="historyContainer">
                    <p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum c√°lculo realizado ainda</p>
                </div>
            </section>

            <section class="tips-section">
                <h2 class="section-title" style="color: white;">
                    üí° Calculadora Avan√ßada
                </h2>
                <div class="advanced-grid">
                    <div class="advanced-card">
                        <div class="advanced-title">üîÑ Convers√£o de Taxas</div>
                        <div class="conversion-controls">
                            <input type="number" id="monthlyRate" placeholder="Taxa mensal %" step="0.1">
                            <button onclick="convertRates()" class="convert-btn">Converter</button>
                            <div id="conversionResult" class="conversion-result"></div>
                        </div>
                    </div>
                    <div class="advanced-card">
                        <div class="advanced-title">üìÖ Calculadora de Prazo</div>
                        <div class="deadline-controls">
                            <input type="date" id="startDate">
                            <input type="number" id="daysToAdd" placeholder="Dias" min="1">
                            <button onclick="calculateDeadline()" class="convert-btn">Calcular</button>
                            <div id="deadlineResult" class="conversion-result"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="statistics-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">
                        üìä Estat√≠sticas
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="convert-btn" onclick="exportData()" style="padding: 8px 15px; font-size: 0.8rem; background: #3498db; border: 2px solid #2980b9;">
                            üì§ Exportar
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="convert-btn" onclick="document.getElementById('importFile').click()" style="padding: 8px 15px; font-size: 0.8rem; background: #e67e22; border: 2px solid #d35400;">
                            üì• Importar
                        </button>
                        <button class="convert-btn" onclick="resetStatistics()" style="padding: 8px 15px; font-size: 0.8rem; background: #e74c3c; border: 2px solid #c0392b;">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label for="startDateFilter" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.85rem;">Data Inicial</label>
                            <input type="date" id="startDateFilter" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label for="endDateFilter" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.85rem;">Data Final</label>
                            <input type="date" id="endDateFilter" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="filterStatistics()" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                üîç Filtrar
                            </button>
                            <button onclick="clearDateFilter()" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                ‚úñÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                    <div id="dateRangeInfo" style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 0.8rem; color: #1565c0; display: none;">
                        üìÖ Mostrando dados de <span id="dateRangeText"></span>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalLoaned">R$ 0,00</div>
                            <div class="stat-label">Total Emprestado</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalProfit">R$ 0,00</div>
                            <div class="stat-label">Lucro Total</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="avgRate">0%</div>
                            <div class="stat-label">Taxa M√©dia</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalCalculations">0</div>
                            <div class="stat-label">C√°lculos Hoje</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Sistema de Banco de Dados Local Avan√ßado
        class LupinDatabase {
            constructor() {
                this.dbName = 'LupinCredDB';
                this.version = 1;
                this.db = null;
                this.init();
            }

            async init() {
                try {
                    // Tenta usar IndexedDB primeiro (mais robusto)
                    if ('indexedDB' in window) {
                        await this.initIndexedDB();
                    } else {
                        // Fallback para localStorage com backup autom√°tico
                        this.initLocalStorage();
                    }
                    this.setupAutoSave();
                } catch (error) {
                    console.log('Usando localStorage como fallback');
                    this.initLocalStorage();
                }
            }

            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Criar stores se n√£o existirem
                        if (!db.objectStoreNames.contains('customers')) {
                            db.createObjectStore('customers', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('history')) {
                            db.createObjectStore('history', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('stats')) {
                            db.createObjectStore('stats', { keyPath: 'date' });
                        }
                    };
                });
            }

            initLocalStorage() {
                // Migrar dados existentes se necess√°rio
                this.migrateFromLocalStorage();
            }

            migrateFromLocalStorage() {
                const oldCustomers = localStorage.getItem('customers');
                const oldHistory = localStorage.getItem('loanHistory');
                const oldStats = localStorage.getItem('dailyStats');
                
                if (oldCustomers) {
                    this.saveToStorage('customers', JSON.parse(oldCustomers));
                }
                if (oldHistory) {
                    this.saveToStorage('history', JSON.parse(oldHistory));
                }
                if (oldStats) {
                    this.saveToStorage('stats', JSON.parse(oldStats));
                }
            }

            async saveToStorage(store, data) {
                try {
                    if (this.db) {
                        // Usar IndexedDB
                        const transaction = this.db.transaction([store], 'readwrite');
                        const objectStore = transaction.objectStore(store);
                        
                        if (Array.isArray(data)) {
                            // Limpar store primeiro
                            await objectStore.clear();
                            // Adicionar todos os itens
                            data.forEach(item => objectStore.add(item));
                        } else {
                            objectStore.put(data);
                        }
                    } else {
                        // Fallback para localStorage
                        localStorage.setItem(`lupinDB_${store}`, JSON.stringify(data));
                    }
                    this.showSaveIndicator();
                } catch (error) {
                    // Fallback para localStorage em caso de erro
                    localStorage.setItem(`lupinDB_${store}`, JSON.stringify(data));
                    this.showSaveIndicator();
                }
            }

            async loadFromStorage(store) {
                try {
                    if (this.db) {
                        // Usar IndexedDB
                        return new Promise((resolve) => {
                            const transaction = this.db.transaction([store], 'readonly');
                            const objectStore = transaction.objectStore(store);
                            const request = objectStore.getAll();
                            
                            request.onsuccess = () => resolve(request.result || []);
                            request.onerror = () => {
                                // Fallback para localStorage
                                const data = localStorage.getItem(`lupinDB_${store}`);
                                resolve(data ? JSON.parse(data) : []);
                            };
                        });
                    } else {
                        // Usar localStorage
                        const data = localStorage.getItem(`lupinDB_${store}`);
                        return data ? JSON.parse(data) : [];
                    }
                } catch (error) {
                    // Fallback final
                    const data = localStorage.getItem(`lupinDB_${store}`);
                    return data ? JSON.parse(data) : [];
                }
            }

            setupAutoSave() {
                // Salvar dados a cada 30 segundos
                setInterval(() => {
                    this.autoSave();
                }, 30000);

                // Salvar antes de fechar a p√°gina
                window.addEventListener('beforeunload', () => {
                    this.autoSave();
                });

                // Salvar quando a p√°gina perde o foco
                window.addEventListener('blur', () => {
                    this.autoSave();
                });
            }

            autoSave() {
                if (customers.length > 0) {
                    this.saveToStorage('customers', customers);
                }
                if (calculationHistory.length > 0) {
                    this.saveToStorage('history', calculationHistory);
                }
                this.saveToStorage('stats', dailyStats);
            }

            showSaveIndicator() {
                const indicator = document.getElementById('saveIndicator');
                if (indicator) {
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 2000);
                }
            }

            async exportAllData() {
                const data = {
                    customers: await this.loadFromStorage('customers'),
                    history: await this.loadFromStorage('history'),
                    allStats: await this.loadFromStorage('allStats'),
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                return data;
            }

            async importAllData(data) {
                try {
                    if (data.customers) {
                        await this.saveToStorage('customers', data.customers);
                        customers = data.customers;
                    }
                    if (data.history) {
                        await this.saveToStorage('history', data.history);
                        calculationHistory = data.history;
                    }
                    
                    // Compatibilidade com vers√µes antigas
                    if (data.allStats) {
                        await this.saveToStorage('allStats', data.allStats);
                        allStats = data.allStats;
                        // Encontrar estat√≠sticas do dia atual
                        const today = new Date().toDateString();
                        dailyStats = allStats.find(stat => stat.date === today) || {
                            totalLoaned: 0,
                            totalProfit: 0,
                            totalCalculations: 0,
                            rates: [],
                            date: today
                        };
                    } else if (data.stats) {
                        // Importar formato antigo
                        allStats = [data.stats];
                        dailyStats = data.stats;
                        await this.saveToStorage('allStats', allStats);
                    }
                    
                    // Atualizar displays
                    displayCustomers();
                    displayHistory();
                    displayDailyStats();
                    clearDateFilter();
                    
                    return true;
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    return false;
                }
            }
        }

        // Inicializar banco de dados
        const lupinDB = new LupinDatabase();

        // Vari√°veis globais
        let calculationHistory = [];
        let customers = [];
        let allStats = []; // Array para armazenar estat√≠sticas de m√∫ltiplas datas
        let dailyStats = {
            totalLoaned: 0,
            totalProfit: 0,
            totalCalculations: 0,
            rates: [],
            date: new Date().toDateString()
        };
        let currentCalculation = null;
        let currentStatsFilter = null; // Para controlar o filtro atual

        // Carregar dados na inicializa√ß√£o
        async function loadAllData() {
            try {
                customers = await lupinDB.loadFromStorage('customers') || [];
                calculationHistory = await lupinDB.loadFromStorage('history') || [];
                allStats = await lupinDB.loadFromStorage('allStats') || [];
                
                // Encontrar ou criar estat√≠sticas do dia atual
                const today = new Date().toDateString();
                let todayStats = allStats.find(stat => stat.date === today);
                
                if (!todayStats) {
                    todayStats = {
                        totalLoaned: 0,
                        totalProfit: 0,
                        totalCalculations: 0,
                        rates: [],
                        date: today
                    };
                    allStats.push(todayStats);
                    await lupinDB.saveToStorage('allStats', allStats);
                }
                
                dailyStats = todayStats;
            } catch (error) {
                console.log('Carregando dados do localStorage como fallback');
                // Fallback para localStorage antigo
                calculationHistory = JSON.parse(localStorage.getItem('loanHistory')) || [];
                customers = JSON.parse(localStorage.getItem('customers')) || [];
                const oldStats = JSON.parse(localStorage.getItem('dailyStats'));
                
                if (oldStats) {
                    allStats = [oldStats];
                    dailyStats = oldStats;
                } else {
                    const today = new Date().toDateString();
                    dailyStats = {
                        totalLoaned: 0,
                        totalProfit: 0,
                        totalCalculations: 0,
                        rates: [],
                        date: today
                    };
                    allStats = [dailyStats];
                }
                await lupinDB.saveToStorage('allStats', allStats);
            }
        }

        // Fun√ß√µes de exporta√ß√£o e importa√ß√£o
        async function exportData() {
            try {
                const data = await lupinDB.exportAllData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `lupin-cred-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Mostrar confirma√ß√£o
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Exportado!';
                btn.style.background = '#27ae60';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#3498db';
                }, 2000);
            } catch (error) {
                alert('Erro ao exportar dados. Tente novamente.');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (await lupinDB.importAllData(data)) {
                    // Mostrar confirma√ß√£o
                    const btn = document.querySelector('[onclick="document.getElementById(\'importFile\').click()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Importado!';
                    btn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#e67e22';
                    }, 2000);
                } else {
                    alert('Erro ao importar dados. Verifique o arquivo.');
                }
            } catch (error) {
                alert('Arquivo inv√°lido. Selecione um backup v√°lido do Lupin Cred.');
            }
            
            // Limpar input
            event.target.value = '';
        }

        // Reset daily stats if it's a new day
        if (dailyStats.date !== new Date().toDateString()) {
            dailyStats = {
                totalLoaned: 0,
                totalProfit: 0,
                totalCalculations: 0,
                rates: [],
                date: new Date().toDateString()
            };
            localStorage.setItem('dailyStats', JSON.stringify(dailyStats));
        }

        function setRate(rate) {
            document.getElementById('interestRate').value = rate;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'percent',
                minimumFractionDigits: 2
            }).format(value / 100);
        }

        function formatPhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return `(${cleaned.slice(0,2)}) ${cleaned.slice(2,7)}-${cleaned.slice(7)}`;
            }
            return phone;
        }

        function formatCPF(cpf) {
            const cleaned = cpf.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return `${cleaned.slice(0,3)}.${cleaned.slice(3,6)}.${cleaned.slice(6,9)}-${cleaned.slice(9)}`;
            }
            return cpf;
        }

        function calculateInterest(principal, rate, period, periodType, interestType) {
            let periodInDays = period;
            
            if (periodType === 'months') {
                periodInDays = period * 30;
            } else if (periodType === 'years') {
                periodInDays = period * 365;
            }

            let totalAmount;
            
            if (interestType === 'simple') {
                const interest = principal * (rate / 100) * (periodInDays / 30);
                totalAmount = principal + interest;
            } else {
                const monthlyRate = rate / 100;
                const periods = periodInDays / 30;
                totalAmount = principal * Math.pow(1 + monthlyRate, periods);
            }

            return {
                totalAmount: totalAmount,
                interestEarned: totalAmount - principal,
                profitability: ((totalAmount - principal) / principal) * 100
            };
        }

        function generateComparison(principal, period, periodType, interestType, currentRate) {
            const rates = [15, 20, 25, 30, 35, 40];
            const comparisonData = [];
            
            const currentResult = calculateInterest(principal, currentRate, period, periodType, interestType);
            
            rates.forEach(rate => {
                const result = calculateInterest(principal, rate, period, periodType, interestType);
                const difference = result.totalAmount - currentResult.totalAmount;
                
                comparisonData.push({
                    rate: rate,
                    interest: result.interestEarned,
                    total: result.totalAmount,
                    difference: difference
                });
            });
            
            return comparisonData;
        }

        function displayComparison(comparisonData) {
            const table = document.getElementById('comparisonTable');
            const tbody = document.getElementById('comparisonBody');
            
            tbody.innerHTML = '';
            
            comparisonData.forEach(data => {
                const row = tbody.insertRow();
                const differenceClass = data.difference > 0 ? 'profit-value' : (data.difference < 0 ? 'text-danger' : '');
                const differenceSymbol = data.difference > 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>${data.rate}%</td>
                    <td>${formatCurrency(data.interest)}</td>
                    <td>${formatCurrency(data.total)}</td>
                    <td class="${differenceClass}">${differenceSymbol}${formatCurrency(data.difference)}</td>
                `;
            });
            
            table.style.display = 'table';
        }

        function convertRates() {
            const monthlyRate = parseFloat(document.getElementById('monthlyRate').value);
            if (!monthlyRate) return;
            
            const dailyRate = monthlyRate / 30;
            const yearlyRate = monthlyRate * 12;
            
            document.getElementById('conversionResult').innerHTML = `
                <strong>Di√°ria:</strong> ${dailyRate.toFixed(2)}%<br>
                <strong>Anual:</strong> ${yearlyRate.toFixed(1)}%
            `;
        }

        function calculateDeadline() {
            const startDate = document.getElementById('startDate').value;
            const daysToAdd = parseInt(document.getElementById('daysToAdd').value);
            
            if (!startDate || !daysToAdd) return;
            
            const start = new Date(startDate);
            const end = new Date(start);
            end.setDate(start.getDate() + daysToAdd);
            
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            document.getElementById('deadlineResult').innerHTML = `
                <strong>Vencimento:</strong><br>
                ${end.toLocaleDateString('pt-BR', options)}
            `;
        }

        function showCustomerForm() {
            if (currentCalculation) {
                document.getElementById('customerSection').style.display = 'block';
                document.getElementById('loanActions').style.display = 'none';
                
                // Set default due date (30 days from today)
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            }
        }

        function hideCustomerForm() {
            document.getElementById('customerSection').style.display = 'none';
            document.getElementById('loanActions').style.display = 'block';
        }

        async function addCustomer(customerData) {
            const customer = {
                id: Date.now(),
                ...customerData,
                loanDate: new Date().toLocaleDateString('pt-BR'),
                status: 'active'
            };
            
            customers.unshift(customer);
            await lupinDB.saveToStorage('customers', customers);
            displayCustomers();
            updateDailyStats(currentCalculation);
        }

        function displayCustomers() {
            const container = document.getElementById('customersContainer');
            
            if (customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum cliente cadastrado ainda</p>';
                return;
            }
            
            const activeCustomers = customers.filter(c => c.status === 'active');
            
            if (activeCustomers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Todos os empr√©stimos foram quitados</p>';
                return;
            }
            
            container.innerHTML = activeCustomers.map(customer => {
                const dueDate = new Date(customer.dueDate);
                const today = new Date();
                const isOverdue = dueDate < today;
                const dueDateClass = isOverdue ? 'overdue' : '';
                
                return `
                    <div class="customer-card">
                        <div class="customer-header">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-debt">${formatCurrency(customer.totalAmount)}</div>
                        </div>
                        
                        <div class="customer-info">
                            üì± ${formatPhone(customer.phone)}
                            ${customer.cpf ? `‚Ä¢ üìÑ ${formatCPF(customer.cpf)}` : ''}
                        </div>
                        
                        ${customer.address ? `<div class="customer-info">üìç ${customer.address}</div>` : ''}
                        
                        <div class="customer-info">
                            üí∞ Emprestado: ${formatCurrency(customer.principal)} ‚Ä¢ 
                            üìà Juros: ${formatCurrency(customer.interestEarned)} (${customer.rate}%)
                        </div>
                        
                        <div class="due-date ${dueDateClass}">
                            ${isOverdue ? '‚ö†Ô∏è Vencido em' : 'üìÖ Vence em'} ${dueDate.toLocaleDateString('pt-BR')}
                        </div>
                        
                        <div class="customer-actions">
                            <button class="action-btn paid-btn" onclick="markAsPaid(${customer.id})">
                                ‚úÖ Pago
                            </button>
                            <button class="action-btn contact-btn" onclick="contactCustomer('${customer.phone}', '${customer.name}', ${customer.totalAmount})">
                                üì± Contatar
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteCustomer(${customer.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function markAsPaid(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.status = 'paid';
                customer.paidDate = new Date().toLocaleDateString('pt-BR');
                await lupinDB.saveToStorage('customers', customers);
                displayCustomers();
                
                // Show success message
                const customerCard = event.target.closest('.customer-card');
                customerCard.style.background = '#d4edda';
                customerCard.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #155724;">
                        <h3>‚úÖ Empr√©stimo Quitado!</h3>
                        <p><strong>${customer.name}</strong> pagou ${formatCurrency(customer.totalAmount)}</p>
                        <p>Lucro obtido: ${formatCurrency(customer.interestEarned)}</p>
                    </div>
                `;
                
                setTimeout(() => {
                    displayCustomers();
                }, 3000);
            }
        }

        function contactCustomer(phone, name, amount) {
            const cleanPhone = phone.replace(/\D/g, '');
            const message = `Ol√° ${name}! Lembrete sobre seu empr√©stimo no valor de ${formatCurrency(amount)}. Entre em contato para acertarmos. Obrigado!`;
            const whatsappUrl = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        async function deleteCustomer(customerId) {
            customers = customers.filter(c => c.id !== customerId);
            await lupinDB.saveToStorage('customers', customers);
            displayCustomers();
        }

        async function clearCustomers() {
            customers = [];
            await lupinDB.saveToStorage('customers', []);
            displayCustomers();
        }

        async function updateDailyStats(calculation) {
            dailyStats.totalLoaned += calculation.principal;
            dailyStats.totalProfit += calculation.interestEarned;
            dailyStats.totalCalculations += 1;
            dailyStats.rates.push(calculation.rate);
            
            // Atualizar no array de todas as estat√≠sticas
            const index = allStats.findIndex(stat => stat.date === dailyStats.date);
            if (index !== -1) {
                allStats[index] = dailyStats;
            }
            
            await lupinDB.saveToStorage('allStats', allStats);
            displayDailyStats();
        }

        function displayDailyStats(statsToShow = null) {
            const stats = statsToShow || dailyStats;
            
            document.getElementById('totalLoaned').textContent = formatCurrency(stats.totalLoaned);
            document.getElementById('totalProfit').textContent = formatCurrency(stats.totalProfit);
            document.getElementById('totalCalculations').textContent = stats.totalCalculations;
            
            const avgRate = stats.rates && stats.rates.length > 0 
                ? stats.rates.reduce((a, b) => a + b, 0) / stats.rates.length 
                : 0;
            document.getElementById('avgRate').textContent = avgRate.toFixed(1) + '%';
        }

        function filterStatistics() {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione as datas inicial e final');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('A data inicial deve ser anterior √† data final');
                return;
            }
            
            // Filtrar estat√≠sticas por per√≠odo
            const filteredStats = allStats.filter(stat => {
                const statDate = new Date(stat.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                return statDate >= start && statDate <= end;
            });
            
            // Consolidar estat√≠sticas do per√≠odo
            const consolidatedStats = {
                totalLoaned: 0,
                totalProfit: 0,
                totalCalculations: 0,
                rates: []
            };
            
            filteredStats.forEach(stat => {
                consolidatedStats.totalLoaned += stat.totalLoaned || 0;
                consolidatedStats.totalProfit += stat.totalProfit || 0;
                consolidatedStats.totalCalculations += stat.totalCalculations || 0;
                if (stat.rates && stat.rates.length > 0) {
                    consolidatedStats.rates.push(...stat.rates);
                }
            });
            
            // Mostrar estat√≠sticas consolidadas
            displayDailyStats(consolidatedStats);
            
            // Mostrar informa√ß√£o do per√≠odo
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            const dateRangeText = document.getElementById('dateRangeText');
            
            const startFormatted = new Date(startDate).toLocaleDateString('pt-BR');
            const endFormatted = new Date(endDate).toLocaleDateString('pt-BR');
            
            dateRangeText.textContent = `${startFormatted} at√© ${endFormatted}`;
            dateRangeInfo.style.display = 'block';
            
            currentStatsFilter = { startDate, endDate, stats: consolidatedStats };
        }

        function clearDateFilter() {
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('dateRangeInfo').style.display = 'none';
            
            // Voltar para estat√≠sticas do dia atual
            displayDailyStats();
            currentStatsFilter = null;
        }

        async function resetStatistics() {
            const confirmReset = confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso ir√° apagar TODAS as estat√≠sticas salvas permanentemente.\n\nTem certeza que deseja continuar?');
            
            if (confirmReset) {
                const doubleConfirm = confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nTodos os dados de estat√≠sticas ser√£o perdidos para sempre.\n\nConfirma o reset completo?');
                
                if (doubleConfirm) {
                    // Reset completo das estat√≠sticas
                    const today = new Date().toDateString();
                    dailyStats = {
                        totalLoaned: 0,
                        totalProfit: 0,
                        totalCalculations: 0,
                        rates: [],
                        date: today
                    };
                    
                    allStats = [dailyStats];
                    await lupinDB.saveToStorage('allStats', allStats);
                    
                    // Limpar filtros
                    clearDateFilter();
                    
                    // Mostrar confirma√ß√£o
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Resetado!';
                    btn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#e74c3c';
                    }, 2000);
                }
            }
        }

        async function addToHistory(calculation) {
            calculation.id = Date.now(); // Adicionar ID √∫nico
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 10) {
                calculationHistory = calculationHistory.slice(0, 10);
            }
            await lupinDB.saveToStorage('history', calculationHistory);
            displayHistory();
        }

        function displayHistory() {
            const container = document.getElementById('historyContainer');
            
            if (calculationHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; font-style: italic;">Nenhum c√°lculo realizado ainda</p>';
                return;
            }
            
            container.innerHTML = calculationHistory.map(calc => `
                <div class="history-item">
                    <div>
                        <strong>${formatCurrency(calc.principal)}</strong> a <strong>${calc.rate}%</strong> por <strong>${calc.period} ${calc.periodType}</strong>
                        <br>
                        <small style="color: #6c757d;">${calc.interestType === 'simple' ? 'Juros Simples' : 'Juros Compostos'} - ${calc.date}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #27ae60; font-weight: 600;">${formatCurrency(calc.totalAmount)}</div>
                        <small style="color: #6c757d;">Lucro: ${formatCurrency(calc.interestEarned)}</small>
                    </div>
                </div>
            `).join('');
        }

        async function clearHistory() {
            calculationHistory = [];
            await lupinDB.saveToStorage('history', []);
            displayHistory();
        }

        // Event Listeners
        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('interestRate').value);
            const period = parseInt(document.getElementById('period').value);
            const periodType = document.getElementById('periodType').value;
            const interestType = document.getElementById('interestType').value;
            
            if (!principal || !rate || !period) {
                return;
            }
            
            const result = calculateInterest(principal, rate, period, periodType, interestType);
            
            // Display results
            document.getElementById('totalAmount').textContent = formatCurrency(result.totalAmount);
            document.getElementById('interestEarned').textContent = formatCurrency(result.interestEarned);
            document.getElementById('profitability').textContent = formatPercentage(result.profitability);
            
            // Generate and display comparison
            const comparisonData = generateComparison(principal, period, periodType, interestType, rate);
            displayComparison(comparisonData);
            
            // Store current calculation
            currentCalculation = {
                principal: principal,
                rate: rate,
                period: period,
                periodType: periodType,
                interestType: interestType,
                totalAmount: result.totalAmount,
                interestEarned: result.interestEarned,
                profitability: result.profitability,
                date: new Date().toLocaleDateString('pt-BR')
            };
            
            // Add to history (always)
            addToHistory(currentCalculation);
            
            // Show loan confirmation button
            document.getElementById('loanActions').style.display = 'block';
        });

        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                cpf: document.getElementById('customerCpf').value,
                address: document.getElementById('customerAddress').value,
                dueDate: document.getElementById('dueDate').value,
                ...currentCalculation
            };
            
            addCustomer(customerData);
            
            // Reset form and hide section
            document.getElementById('customerForm').reset();
            document.getElementById('customerSection').style.display = 'none';
            document.getElementById('loanActions').style.display = 'none';
            
            // Show success message
            const btn = document.querySelector('.loan-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Cliente Cadastrado com Sucesso!';
            btn.style.background = '#27ae60';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                document.getElementById('loanActions').style.display = 'block';
            }, 3000);
        });

        // Auto-format phone input
        document.getElementById('customerPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length > 6) {
                    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                }
                e.target.value = value;
            }
        });

        // Auto-format CPF input
        document.getElementById('customerCpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
                e.target.value = value;
            }
        });

        // Set today's date as default
        document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
        
        // Set default dates for statistics filter (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('endDateFilter').value = today.toISOString().split('T')[0];
        document.getElementById('startDateFilter').value = thirtyDaysAgo.toISOString().split('T')[0];

        // Load data on page load
        window.addEventListener('load', async () => {
            await loadAllData();
            displayHistory();
            displayDailyStats();
            displayCustomers();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'990a7dd2b2e9009f',t:'MTc2MDgxNjI1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
